<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.yanqi.cf","root":"/","scheme":"Gemini","version":"8.0.0-rc.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
<meta property="og:type" content="website">
<meta property="og:title" content="blyanqi@163.com">
<meta property="og:url" content="http://blog.yanqi.cf/page/12/index.html">
<meta property="og:site_name" content="blyanqi@163.com">
<meta property="og:description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yan qi">
<meta property="article:tag" content="运维、自动化、devops、容器架构">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.yanqi.cf/page/12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>blyanqi@163.com</title>
  


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?829697829f3ae7ddf2c38de42e2f8f5d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blyanqi@163.com</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanqi.cf/2020/05/Django%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yan qi">
      <meta itemprop="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blyanqi@163.com">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/Django%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Django框架使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-05-14 09:16:35 / 修改时间：09:35:45" itemprop="dateCreated datePublished" datetime="2020-05-14T09:16:35+08:00">2020-05-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">python开发</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h2><ul>
<li><a href="https://docs.djangoproject.com/zh-hans/3.0/" target="_blank" rel="noopener"> Django </a></li>
</ul>
<h2 id="概念-Concepts"><a href="#概念-Concepts" class="headerlink" title="概念 Concepts"></a>概念 Concepts</h2><ul>
<li>项目 project</li>
<li>模板 template</li>
<li>模型 modules</li>
<li>表单 form</li>
<li>视图 view</li>
<li>管理工具<ul>
<li>django-admin</li>
</ul>
</li>
</ul>
<p>brower -&gt; view -&gt; controller -&gt; models</p>
<h3 id="python3-install"><a href="#python3-install" class="headerlink" title="python3 install"></a>python3 install</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.python.org/ftp/python/3.8.2/Python-3.8.2.tgz</span><br><span class="line">tar -zxf Python-3.8.2.tgz </span><br><span class="line">cd Python-3.8.2</span><br><span class="line">./configure  <span class="comment">--prefix /usr/local/python</span></span><br><span class="line">make -j $(/proc/cpuinfo |grep cores|wc -l)</span><br><span class="line">make <span class="keyword">install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置国内镜像源</span></span><br><span class="line">mkdir ~/.pip</span><br><span class="line">cat &lt;&lt;<span class="string">'EOF'</span> &gt;~/.pip/pip.conf </span><br><span class="line">[<span class="keyword">global</span>]</span><br><span class="line"><span class="keyword">index</span>-<span class="keyword">url</span> = <span class="keyword">http</span>://pypi.douban.com/simple</span><br><span class="line">extra-<span class="keyword">index</span>-<span class="keyword">url</span>=https://mirrors.aliyun.com/pypi/simple</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置虚拟环境</span></span><br><span class="line">/usr/<span class="keyword">local</span>/python/<span class="keyword">bin</span>/pip3 <span class="keyword">install</span> <span class="comment">--upgrade pip</span></span><br><span class="line">/usr/<span class="keyword">local</span>/python/<span class="keyword">bin</span>/pip3 <span class="keyword">install</span> virtualenv</span><br><span class="line">/usr/<span class="keyword">local</span>/python/<span class="keyword">bin</span>/virtualenv djangodemo</span><br><span class="line"></span><br><span class="line">echo <span class="string">". djangodemo/bin/activate"</span> &gt;&gt;~/.bash_profile</span><br><span class="line">. djangodemo/<span class="keyword">bin</span>/<span class="keyword">activate</span></span><br><span class="line">pip <span class="keyword">install</span> django</span><br><span class="line">django-<span class="keyword">admin</span> <span class="comment">--version</span></span><br></pre></td></tr></table></figure>
<h3 id="创建了一个项目"><a href="#创建了一个项目" class="headerlink" title="创建了一个项目"></a>创建了一个项目</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject -h</span><br><span class="line">django-admin startproject web1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据库</span></span><br><span class="line">yum -y install mariadb mariadb-devel</span><br><span class="line">systemctl start mariadb</span><br><span class="line">pip install mysqlclient</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库</span></span><br><span class="line">mysql -uroot -p <span class="string">"create database web1"</span></span><br><span class="line">CREATE DATABASE `web1`<span class="built_in"> DEFAULT </span>CHARACTER <span class="builtin-name">SET</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment"># vim web1/setting.py</span></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">"HOST"</span>: <span class="string">'localhost'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'web1'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: 3306,</span><br><span class="line">    <span class="string">'OPTIONS'</span>: &#123;</span><br><span class="line">        <span class="string">'init_command'</span>: <span class="string">'SET default_storage_engine=INNODB'</span>,</span><br><span class="line">        <span class="string">'autocommit'</span>: <span class="literal">True</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许所有主机访问，默认为空，返回 400</span></span><br><span class="line">ALLOWED_HOSTS=[<span class="string">"*"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步数据库</span></span><br><span class="line">python manage.py migrate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建管理员账号</span></span><br><span class="line">python manage.py createsuperuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># admin 模块位置</span></span><br><span class="line">lib/python3.8/site-packages/django/contrib/admin/</span><br><span class="line"><span class="attribute">DEBUG</span>=<span class="literal">True</span></span><br><span class="line">导致 admin 模块的静态文件加载不到</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">python manage.py runserver 0:8000</span><br></pre></td></tr></table></figure>
<h3 id="Django-目录结构"><a href="#Django-目录结构" class="headerlink" title="Django 目录结构"></a>Django 目录结构</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">web1  <span class="meta"># 项目目录</span></span><br><span class="line">web1/manage.py <span class="meta"># 项目管理工具</span></span><br><span class="line">web1/web1  <span class="meta"># </span></span><br><span class="line">web1<span class="meta-keyword">/web1/</span>__init__.py <span class="meta"># 告诉 Python 这个目录应该被认为是一个 Python 包。</span></span><br><span class="line">web1<span class="meta-keyword">/web1/</span>asgi.py     <span class="meta"># ASGI 兼容的Web服务器上的入口</span></span><br><span class="line">web1<span class="meta-keyword">/web1/</span>settings.py <span class="meta"># Django 项目的配置文件</span></span><br><span class="line">web1<span class="meta-keyword">/web1/</span>urls.py     <span class="meta"># Django 项目的 URL 声明 ，路由</span></span><br><span class="line">web1<span class="meta-keyword">/web1/</span>wsgi.py     <span class="meta"># WSGI 兼容的Web服务器上的入口</span></span><br></pre></td></tr></table></figure>
<h3 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> web1</span><br><span class="line"><span class="keyword">python</span> manage.<span class="keyword">py</span> startapp polls</span><br><span class="line"></span><br><span class="line">polls/</span><br><span class="line">├── admin.<span class="keyword">py</span></span><br><span class="line">├── apps.<span class="keyword">py</span></span><br><span class="line">├── __init__.<span class="keyword">py</span></span><br><span class="line">├── migrations</span><br><span class="line">│   └── __init__.<span class="keyword">py</span></span><br><span class="line">├── models.<span class="keyword">py</span></span><br><span class="line">├── tests.<span class="keyword">py</span> </span><br><span class="line">├── urls.<span class="keyword">py</span>  # 路由</span><br><span class="line">└── views.<span class="keyword">py</span> # 视图</span><br></pre></td></tr></table></figure>
<ul>
<li><p>创建项目</p>
<ul>
<li>创建应用<ul>
<li>编写视图</li>
<li>配置路由</li>
<li>配置模型</li>
<li>生成迁移文件<ul>
<li>查看迁移文件</li>
</ul>
</li>
<li>执行迁移</li>
<li>通过 shell 调试</li>
</ul>
</li>
</ul>
</li>
<li><p>后台创建</p>
<ul>
<li>创建后台用户</li>
<li>通过 admin 文件向后台注册表</li>
</ul>
</li>
<li><p>编写多视图</p>
</li>
<li>使用模板来渲染视图</li>
<li>404 页面处理</li>
<li>为 url 添加命名空间</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanqi.cf/2020/05/Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yan qi">
      <meta itemprop="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blyanqi@163.com">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/Kubernetes/" class="post-title-link" itemprop="url">Kubernetes</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-14 09:11:37" itemprop="dateCreated datePublished" datetime="2020-05-14T09:11:37+08:00">2020-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-07 13:21:41" itemprop="dateModified" datetime="2020-06-07T13:21:41+08:00">2020-06-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">容器技术</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><a href="https://kubernetes.io/zh/docs/home/" target="_blank" rel="noopener"> Kubernetes 官网 </a></li>
<li><a href="/2020/05/kubernetes%E5%AE%89%E8%A3%85/" title="kubernetes安装">kubernetes安装</a></li>
<li><a href="/2020/05/kubernetes%E4%BD%BF%E7%94%A8/" title="Kubernetes管理">Kubernetes管理</a>
</li>
</ul>
<h2 id="Kubernetes-概念"><a href="#Kubernetes-概念" class="headerlink" title="Kubernetes 概念"></a>Kubernetes 概念</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群结构</span></span><br><span class="line">    主机 Node</span><br><span class="line">        Master node</span><br><span class="line">        Work node</span><br><span class="line">    Network</span><br><span class="line">    Storage</span><br><span class="line">    ETCD</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群组件</span></span><br><span class="line">controller manager</span><br><span class="line">scheduler</span><br><span class="line">etcd</span><br><span class="line">kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群网络插件</span></span><br><span class="line">Istio</span><br><span class="line">Calico</span><br><span class="line">Flannel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 概念</span></span><br><span class="line">Namespace 项目</span><br><span class="line">pod 容器组 （可以包含多个容器）</span><br><span class="line">deployments (用来部署 pod，指定 pod 策略等)</span><br><span class="line">service 服务（提供 pod 间网络）</span><br><span class="line">Ingress nginx（对 pod 提供应用路由 如:http://pod.com/<span class="built_in">test</span>/）</span><br><span class="line">Image Registries 镜像仓库</span><br><span class="line">PersistentVolume PV 存储卷</span><br><span class="line">PersistentVolumeClaim（PVC)</span><br><span class="line">StorageClass 存储类型</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群管理</span></span><br><span class="line"><span class="comment"># master节点</span></span><br><span class="line">升级(不能降级)</span><br><span class="line">备份/恢复</span><br><span class="line">证书管理</span><br><span class="line">Etcd管理</span><br><span class="line"><span class="comment"># 集群资源限制</span></span><br><span class="line">    不可用节点数限制</span><br><span class="line">    集群API地址授权</span><br><span class="line">    项目资源配额</span><br><span class="line"></span><br><span class="line"><span class="comment"># work节点</span></span><br><span class="line">升级</span><br><span class="line">暂停</span><br><span class="line">驱散</span><br><span class="line"></span><br><span class="line"><span class="comment"># pod 类型</span></span><br><span class="line">Deployment: 部署无状态应用 </span><br><span class="line">DaemonSet: 每台主机部署 1 个Pod</span><br><span class="line">StatefulSet: 部署有状态应用 1 个Pod</span><br><span class="line">CronJob: 定时运行Pod</span><br><span class="line">Job: 一次性运行Pod</span><br><span class="line"></span><br><span class="line"><span class="comment"># pod 卷</span></span><br><span class="line">本地卷</span><br><span class="line">存储卷-&gt;存储类 PVC</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级策略</span></span><br><span class="line">滚动</span><br><span class="line">    先启动新Pod，再停止旧Pod。</span><br><span class="line">    先停止旧Pod，再启动新Pod。</span><br><span class="line">直接升级：删除所有Pod，然后重新开始。</span><br><span class="line">自定义</span><br><span class="line">    最大 pod 数量</span><br><span class="line">    可用 pod 数量</span><br><span class="line">pod 准备时间</span><br><span class="line"></span><br><span class="line"><span class="comment"># pod 网络模式</span></span><br><span class="line">NodePort(所有主机端口均可访问)</span><br><span class="line">HostPort(pod所在主机端口能访问)</span><br><span class="line">集群IP(与pod端口相同，集群内能访问)</span><br><span class="line">L4负载均衡(对接公有云负载均衡)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PV 插件</span></span><br><span class="line">公有云 PV 插件</span><br><span class="line"><span class="built_in">local</span></span><br><span class="line">hostpath</span><br><span class="line">NFS</span><br><span class="line"></span><br><span class="line"><span class="comment"># PV 访问模式</span></span><br><span class="line">单机读写</span><br><span class="line">多机读写</span><br><span class="line">多机只读</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储类</span></span><br><span class="line">回收策略</span><br><span class="line">    随工作负载删除</span><br><span class="line">    保留</span><br><span class="line">卷绑定模式</span><br><span class="line">    创建PersistentVolumeClaim后，绑定并提供一个持久卷</span><br><span class="line">    使用PersistentVolumeClaim创建一个Pod后，绑定并提供一个持久卷</span><br><span class="line"></span><br><span class="line">首先创建 Storage Classes -&gt; 创建PersistentVolume -&gt; Add Volume Claim</span><br><span class="line">在 pod 中使用 PersistentVolumeClaim</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanqi.cf/2020/05/OpenStack%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yan qi">
      <meta itemprop="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blyanqi@163.com">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/OpenStack%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">OpenStack安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-05-14 08:40:48 / 修改时间：09:17:58" itemprop="dateCreated datePublished" datetime="2020-05-14T08:40:48+08:00">2020-05-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/" itemprop="url" rel="index"><span itemprop="name">云计算</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>23k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>21 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><a href="https://www.openstack.org/" target="_blank" rel="noopener"> Openstack 官网 </a></li>
<li><a href="https://docs.openstack.org/install-guide/" target="_blank" rel="noopener">Install 指南</a></li>
<li><a href="https://docs.openstack.org/install-guide/get-started-conceptual-architecture.html" target="_blank" rel="noopener">openstack 架构图</a></li>
<li><a href="https://docs.openstack.org/train/user/" target="_blank" rel="noopener">组件介绍</a></li>
</ul>
<h2 id="组件介绍"><a href="#组件介绍" class="headerlink" title="组件介绍"></a>组件介绍</h2><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Keystone 认证组件</span><br><span class="line">Glance 镜像组件</span><br><span class="line">placement 资源管理组件(是从Nova中剥离出来的)</span><br><span class="line">------------------------</span><br><span class="line">其他组件</span><br><span class="line"></span><br><span class="line">Nova 计算组件</span><br><span class="line">Netron 网络组件</span><br><span class="line">------------------------</span><br><span class="line">Master Node</span><br><span class="line"></span><br><span class="line">Nova 计算组件</span><br><span class="line">Netron 网络组件</span><br><span class="line">------------------------</span><br><span class="line">Worker Node</span><br></pre></td></tr></table></figure>
<h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><p>提供5台 linux 系统(Centos 7) 主机</p>
<p>主机IP如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">master:<span class="number">192.168</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">work1:<span class="number">192.168</span><span class="number">.0</span><span class="number">.52</span></span><br><span class="line">work2:<span class="number">192.168</span><span class="number">.0</span><span class="number">.53</span></span><br></pre></td></tr></table></figure>
<h3 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h3><h4 id="设置主机名"><a href="#设置主机名" class="headerlink" title="设置主机名"></a>设置主机名</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh <span class="number">192.168</span><span class="number">.0</span><span class="number">.51</span> <span class="string">" hostnamectl set-hostname controller"</span></span><br><span class="line">ssh <span class="number">192.168</span><span class="number">.0</span><span class="number">.52</span> <span class="string">" hostnamectl set-hostname work1"</span></span><br><span class="line">ssh <span class="number">192.168</span><span class="number">.0</span><span class="number">.53</span> <span class="string">" hostnamectl set-hostname work2"</span></span><br></pre></td></tr></table></figure>
<h4 id="设置主机名解析"><a href="#设置主机名解析" class="headerlink" title="设置主机名解析"></a>设置主机名解析</h4><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo "<span class="number">192.168.0.51</span> controller</span><br><span class="line"><span class="number">192.168.0.52</span> work1</span><br><span class="line"><span class="number">192.168.0.53</span> work2"&gt;&gt;/etc/hosts</span><br></pre></td></tr></table></figure>
<h4 id="生成ssh-key"><a href="#生成ssh-key" class="headerlink" title="生成ssh key"></a>生成ssh key</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id <span class="number">192.168</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">ssh-copy-id <span class="number">192.168</span><span class="number">.0</span><span class="number">.52</span></span><br><span class="line">ssh-copy-id <span class="number">192.168</span><span class="number">.0</span><span class="number">.53</span></span><br><span class="line"></span><br><span class="line">SSHVerify</span><br></pre></td></tr></table></figure>
<blockquote>
<p>for x in <code>grep -o -.* /etc/hosts</code>;do echo $x; ssh-copy-id $x ;done</p>
</blockquote>
<h4 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">systemctl</span> <span class="string">stop firewalld</span></span><br><span class="line"><span class="attr">iptables</span> <span class="string">-L -n</span></span><br></pre></td></tr></table></figure>
<h4 id="关闭-selinux"><a href="#关闭-selinux" class="headerlink" title="关闭 selinux"></a>关闭 selinux</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce <span class="number">0</span></span><br><span class="line">sed -i <span class="string">"s/^SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/<span class="built_in">config</span></span><br></pre></td></tr></table></figure>
<h4 id="关闭-swap"><a href="#关闭-swap" class="headerlink" title="关闭 swap"></a>关闭 swap</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">swapoff -<span class="selector-tag">a</span> sed -<span class="selector-tag">i</span> <span class="string">'s/.*swap.*/#&amp;/'</span> /etc/fstab</span><br></pre></td></tr></table></figure>
<h3 id="NTP-配置"><a href="#NTP-配置" class="headerlink" title="NTP 配置"></a>NTP 配置</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install chrony -y</span><br><span class="line"><span class="comment"># vim /etc/chrony.conf</span></span><br><span class="line">sed -i <span class="string">"/^server/d"</span> <span class="regexp">/etc/</span>chrony.conf</span><br><span class="line">sed -i <span class="string">"2a server ntp1.cloud.aliyuncs.com iburst"</span> <span class="regexp">/etc/</span>chrony.conf</span><br><span class="line">sed -i <span class="string">"2a server ntp2.cloud.aliyuncs.com iburst"</span> <span class="regexp">/etc/</span>chrony.conf </span><br><span class="line">sed -i <span class="string">"/#allow/s/#//"</span> <span class="regexp">/etc/</span>chrony.conf</span><br><span class="line">systemctl enable chronyd.service;systemctl start chronyd.service</span><br></pre></td></tr></table></figure>
<h3 id="生成随机密码（安装时使用统一密码）"><a href="#生成随机密码（安装时使用统一密码）" class="headerlink" title="生成随机密码（安装时使用统一密码）"></a>生成随机密码（安装时使用统一密码）</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl <span class="keyword">rand</span> -<span class="keyword">hex</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>
<h3 id="设置-train-版本的源"><a href="#设置-train-版本的源" class="headerlink" title="设置 train 版本的源"></a>设置 train 版本的源</h3><figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install https:<span class="comment">//rdoproject.org/repos/rdo-release.rpm</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 安装所需的yum 库</span></span><br><span class="line">yum -<span class="symbol">y</span> install centos-release-openstack-train</span><br><span class="line">yum repolist</span><br><span class="line">yum upgrade -<span class="symbol">y</span></span><br><span class="line">yum install python-openstackclient -<span class="symbol">y</span></span><br><span class="line">yum install openstack-selinux -<span class="symbol">y</span></span><br></pre></td></tr></table></figure>
<h3 id="数据库安装"><a href="#数据库安装" class="headerlink" title="数据库安装"></a>数据库安装</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> mariadb mariadb-<span class="keyword">server</span> python2-PyMySQL -y</span><br><span class="line"> </span><br><span class="line">vim /etc/my.cnf.d/openstack.cnf</span><br><span class="line"> </span><br><span class="line">[mysqld]</span><br><span class="line">bind-address = <span class="number">192.168</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line"><span class="keyword">default</span>-<span class="keyword">storage</span>-<span class="keyword">engine</span> = <span class="keyword">innodb</span></span><br><span class="line">innodb_file_per_table</span><br><span class="line">max_connections = <span class="number">4096</span></span><br><span class="line"><span class="keyword">collation</span>-<span class="keyword">server</span> = utf8_general_ci</span><br><span class="line"><span class="built_in">character</span>-<span class="keyword">set</span>-<span class="keyword">server</span> = utf8</span><br><span class="line"> </span><br><span class="line">systemctl <span class="keyword">enable</span> mariadb.service</span><br><span class="line">systemctl <span class="keyword">start</span> mariadb.service</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 数据库安装</span></span><br><span class="line"><span class="comment">#validate</span></span><br><span class="line">netstat -ntlp |grep <span class="number">3306</span></span><br><span class="line"> </span><br><span class="line">mysql_secure_installation</span><br><span class="line">n y....</span><br></pre></td></tr></table></figure>
<h3 id="消息队列安装"><a href="#消息队列安装" class="headerlink" title="消息队列安装"></a>消息队列安装</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">安装 rabbitmq</span><br><span class="line">yum install rabbitmq-<span class="keyword">server</span> -y</span><br><span class="line"> </span><br><span class="line">systemctl <span class="keyword">enable</span> rabbitmq-<span class="keyword">server</span>.service</span><br><span class="line">systemctl <span class="keyword">start</span> rabbitmq-<span class="keyword">server</span>.service</span><br><span class="line"> </span><br><span class="line"><span class="meta">#validate</span></span><br><span class="line">netstat -ntlp|grep <span class="number">25672</span></span><br><span class="line"></span><br><span class="line"># 添加用户，设置权限</span><br><span class="line">rabbitmqctl add_user openstack RABBIT_PASS</span><br><span class="line">rabbitmqctl set_permissions openstack ".*" ".*" ".*"</span><br></pre></td></tr></table></figure>
<h3 id="Memcached-安装"><a href="#Memcached-安装" class="headerlink" title="Memcached 安装"></a>Memcached 安装</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">yum</span> <span class="string">install memcached python-memcached -y</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">vim</span> <span class="string">/etc/sysconfig/memcached</span></span><br><span class="line"><span class="attr">OPTIONS</span>=<span class="string">"-l 127.0.0.1,::1,controller"</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">systemctl</span> <span class="string">enable memcached.service</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">start memcached.service</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># validate</span></span><br><span class="line"><span class="attr">netstat</span> <span class="string">-ntlp |grep 11211</span></span><br></pre></td></tr></table></figure>
<h3 id="Etcd-安装"><a href="#Etcd-安装" class="headerlink" title="Etcd 安装"></a>Etcd 安装</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum install etcd -y</span><br><span class="line"> </span><br><span class="line">vim /etc/etcd/etcd.conf</span><br><span class="line"> </span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line"><span class="attribute">ETCD_DATA_DIR</span>=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line"><span class="attribute">ETCD_LISTEN_PEER_URLS</span>=<span class="string">"http://10.0.0.11:2380"</span></span><br><span class="line"><span class="attribute">ETCD_LISTEN_CLIENT_URLS</span>=<span class="string">"http://10.0.0.11:2379"</span></span><br><span class="line"><span class="attribute">ETCD_NAME</span>=<span class="string">"controller"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line"><span class="attribute">ETCD_INITIAL_ADVERTISE_PEER_URLS</span>=<span class="string">"http://10.0.0.11:2380"</span></span><br><span class="line"><span class="attribute">ETCD_ADVERTISE_CLIENT_URLS</span>=<span class="string">"http://10.0.0.11:2379"</span></span><br><span class="line"><span class="attribute">ETCD_INITIAL_CLUSTER</span>=<span class="string">"controller=http://10.0.0.11:2380"</span></span><br><span class="line"><span class="attribute">ETCD_INITIAL_CLUSTER_TOKEN</span>=<span class="string">"etcd-cluster-01"</span></span><br><span class="line"><span class="attribute">ETCD_INITIAL_CLUSTER_STATE</span>=<span class="string">"new"</span></span><br><span class="line"> </span><br><span class="line">systemctl <span class="builtin-name">enable</span> etcd</span><br><span class="line">systemctl start etcd</span><br><span class="line"> </span><br><span class="line">netstat -ntlp|grep etcd</span><br></pre></td></tr></table></figure>
<h2 id="Openstack-组件安装"><a href="#Openstack-组件安装" class="headerlink" title="Openstack 组件安装"></a>Openstack 组件安装</h2><h3 id="KEYSTONE"><a href="#KEYSTONE" class="headerlink" title="KEYSTONE"></a>KEYSTONE</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数据库</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> keystone;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> keystone.* <span class="keyword">TO</span> <span class="string">'keystone'</span>@<span class="string">'localhost'</span> \</span><br><span class="line"><span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'KEYSTONE_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> keystone.* <span class="keyword">TO</span> <span class="string">'keystone'</span>@<span class="string">'%'</span> \</span><br><span class="line"><span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'KEYSTONE_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装包</span></span><br><span class="line">yum <span class="keyword">install</span> openstack-keystone httpd mod_wsgi -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">cp /etc/keystone/keystone.conf /etc/keystone/keystone.conf.bak</span><br><span class="line">grep -v -e <span class="string">"^$"</span> -e <span class="string">"#"</span> /etc/keystone/keystone.conf.bak &gt;/etc/keystone/keystone.conf</span><br><span class="line"> </span><br><span class="line">/etc/keystone/keystone.conf</span><br><span class="line">[<span class="keyword">database</span>]</span><br><span class="line"><span class="comment"># 连接数据库</span></span><br><span class="line"><span class="keyword">connection</span> = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone</span><br><span class="line">[token]</span><br><span class="line"><span class="comment"># token 使用的方式</span></span><br><span class="line">provider = fernet</span><br><span class="line"></span><br><span class="line">初始化身份认证服务的数据库</span><br><span class="line">su -s /<span class="keyword">bin</span>/sh -c <span class="string">"keystone-manage db_sync"</span> keystone</span><br><span class="line"> </span><br><span class="line">查看创建的表</span><br><span class="line"><span class="comment">#validate</span></span><br><span class="line">mysql keystone -e <span class="string">"show tables;"</span></span><br><span class="line"> </span><br><span class="line">// 初始化Fernet <span class="keyword">keys</span></span><br><span class="line">keystone-manage fernet_setup <span class="comment">--keystone-user keystone --keystone-group keystone</span></span><br><span class="line"> </span><br><span class="line">ls /etc/keystone/fernet-<span class="keyword">keys</span>/</span><br><span class="line"> </span><br><span class="line">// 认证设置使用的系统用户，组</span><br><span class="line">keystone-manage credential_setup <span class="comment">--keystone-user keystone --keystone-group keystone</span></span><br><span class="line"> </span><br><span class="line">// 建立身份服务</span><br><span class="line">keystone-manage bootstrap <span class="comment">--bootstrap-password ADMIN_PASS \</span></span><br><span class="line">  <span class="comment">--bootstrap-admin-url http://controller:5000/v3/ \</span></span><br><span class="line">  <span class="comment">--bootstrap-internal-url http://controller:5000/v3/ \</span></span><br><span class="line">  <span class="comment">--bootstrap-public-url http://controller:5000/v3/ \</span></span><br><span class="line">  <span class="comment">--bootstrap-region-id RegionOne</span></span><br><span class="line"> </span><br><span class="line">// Apache 服务配置</span><br><span class="line">vim +<span class="number">95</span> /etc/httpd/conf/httpd.conf</span><br><span class="line">ServerName controller</span><br><span class="line"> </span><br><span class="line"><span class="keyword">ln</span> -s /usr/<span class="keyword">share</span>/keystone/wsgi-keystone.conf /etc/httpd/conf.d/</span><br><span class="line"> </span><br><span class="line"><span class="comment"># systemctl enable httpd.service</span></span><br><span class="line"><span class="comment"># systemctl start httpd.service</span></span><br><span class="line"> </span><br><span class="line">// 设置管理员环境变量</span><br><span class="line"><span class="keyword">export</span> OS_USERNAME=<span class="keyword">admin</span></span><br><span class="line"><span class="keyword">export</span> OS_PASSWORD=ADMIN_PASS</span><br><span class="line"><span class="keyword">export</span> OS_PROJECT_NAME=<span class="keyword">admin</span></span><br><span class="line"><span class="keyword">export</span> OS_USER_DOMAIN_NAME=<span class="keyword">Default</span></span><br><span class="line"><span class="keyword">export</span> OS_PROJECT_DOMAIN_NAME=<span class="keyword">Default</span></span><br><span class="line"><span class="keyword">export</span> OS_AUTH_URL=<span class="keyword">http</span>://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="keyword">export</span> OS_IDENTITY_API_VERSION=<span class="number">3</span></span><br><span class="line"> </span><br><span class="line">// 创建服务实体和API端点</span><br><span class="line">创建一个域(<span class="keyword">default</span> 域 默认存在)</span><br><span class="line">openstack <span class="keyword">domain</span> <span class="keyword">create</span> <span class="comment">--description "An Example Domain" example</span></span><br><span class="line"> </span><br><span class="line">创建一个服务， 隶属于 <span class="keyword">default</span> 域</span><br><span class="line">openstack <span class="keyword">project</span> <span class="keyword">create</span> <span class="comment">--domain default --description "Service Project" service</span></span><br><span class="line"> </span><br><span class="line">创建一个项目，隶属于 <span class="keyword">default</span> 域</span><br><span class="line">openstack <span class="keyword">project</span> <span class="keyword">create</span> <span class="comment">--domain default --description "Demo Project" myproject</span></span><br><span class="line"> </span><br><span class="line">创建一个用户，隶属于 <span class="keyword">default</span> 域</span><br><span class="line">openstack <span class="keyword">user</span> <span class="keyword">create</span> <span class="comment">--domain default --password-prompt myuser</span></span><br><span class="line"><span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">// 创建一个角色</span><br><span class="line">openstack <span class="keyword">role</span> <span class="keyword">create</span> myrole</span><br><span class="line"> </span><br><span class="line">// 关联项目，用户，角色</span><br><span class="line">openstack <span class="keyword">role</span> <span class="keyword">add</span> <span class="comment">--project myproject --user myuser myrole</span></span><br><span class="line"> </span><br><span class="line">// 删除环境变量</span><br><span class="line">unset OS_AUTH_URL OS_PASSWORD</span><br><span class="line"> </span><br><span class="line">// 获取一个token</span><br><span class="line">// api</span><br><span class="line">openstack <span class="comment">--os-auth-url http://controller:5000/v3 \</span></span><br><span class="line">// 项目域 <span class="comment">--os-project-domain-name Default</span></span><br><span class="line">// 用户域</span><br><span class="line"><span class="comment">--os-user-domain-name Default</span></span><br><span class="line">// 项目名 <span class="comment">--os-project-name admin</span></span><br><span class="line">// 用户名</span><br><span class="line"><span class="comment">--os-username admin token issue</span></span><br><span class="line">// 密码</span><br><span class="line">ADMIN_PASS</span><br><span class="line"> </span><br><span class="line">// 获取<span class="keyword">admin</span> 管理员的token</span><br><span class="line">openstack <span class="comment">--os-auth-url http://controller:5000/v3 \</span></span><br><span class="line">  <span class="comment">--os-project-domain-name Default --os-user-domain-name Default \</span></span><br><span class="line">  <span class="comment">--os-project-name admin --os-username admin token issue</span></span><br><span class="line"> </span><br><span class="line">ADMIN_PASS</span><br><span class="line"> </span><br><span class="line">// 获取一个 myproject 的 token</span><br><span class="line">openstack <span class="comment">--os-auth-url http://controller:5000/v3 \</span></span><br><span class="line">  <span class="comment">--os-project-domain-name Default --os-user-domain-name Default \</span></span><br><span class="line">  <span class="comment">--os-project-name myproject --os-username myuser token issue</span></span><br><span class="line"> </span><br><span class="line"><span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">设置一个管理员的环境变量 <span class="keyword">admin</span>-openrc</span><br><span class="line">echo <span class="string">"export OS_PROJECT_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_USER_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_PROJECT_NAME=admin</span></span><br><span class="line"><span class="string">export OS_USERNAME=admin</span></span><br><span class="line"><span class="string">export OS_PASSWORD=ADMIN_PASS</span></span><br><span class="line"><span class="string">export OS_AUTH_URL=http://controller:5000/v3</span></span><br><span class="line"><span class="string">export OS_IDENTITY_API_VERSION=3</span></span><br><span class="line"><span class="string">export OS_IMAGE_API_VERSION=2"</span> &gt;<span class="keyword">admin</span>-openrc</span><br><span class="line"> </span><br><span class="line">设置一个demo的环境变量 demo-openrc</span><br><span class="line">echo <span class="string">"export OS_PROJECT_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_USER_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_PROJECT_NAME=myproject</span></span><br><span class="line"><span class="string">export OS_USERNAME=myuser</span></span><br><span class="line"><span class="string">export OS_PASSWORD=123456</span></span><br><span class="line"><span class="string">export OS_AUTH_URL=http://controller:5000/v3</span></span><br><span class="line"><span class="string">export OS_IDENTITY_API_VERSION=3</span></span><br><span class="line"><span class="string">export OS_IMAGE_API_VERSION=2"</span>&gt;demo-openrc</span><br><span class="line"> </span><br><span class="line">// 获得一个token</span><br><span class="line">. <span class="keyword">admin</span>-openrc</span><br><span class="line">openstack token issue</span><br><span class="line"> </span><br><span class="line">. demo-openrc</span><br><span class="line">openstack token issue</span><br></pre></td></tr></table></figure>
<h3 id="Glance-安装"><a href="#Glance-安装" class="headerlink" title="Glance 安装"></a>Glance 安装</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> glance;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> glance.* <span class="keyword">TO</span> <span class="string">'glance'</span>@<span class="string">'localhost'</span> \</span><br><span class="line">  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'GLANCE_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> glance.* <span class="keyword">TO</span> <span class="string">'glance'</span>@<span class="string">'%'</span> \</span><br><span class="line">  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'GLANCE_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line">// 注册 glance</span><br><span class="line">. admin-openrc</span><br><span class="line">openstack user <span class="keyword">create</span> <span class="comment">--domain default --password-prompt glance</span></span><br><span class="line"><span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">openstack <span class="keyword">role</span> <span class="keyword">add</span> <span class="comment">--project service --user glance admin</span></span><br><span class="line"> </span><br><span class="line">// 创建服务</span><br><span class="line">openstack service <span class="keyword">create</span> <span class="comment">--name glance \</span></span><br><span class="line">  <span class="comment">--description "OpenStack Image" image</span></span><br><span class="line"> </span><br><span class="line">// 创建 <span class="keyword">public</span> 网络 image</span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne image public http://controller:9292</span></span><br><span class="line"> </span><br><span class="line">// 创建 internal 网络 image</span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne image internal http://controller:9292</span></span><br><span class="line"> </span><br><span class="line">// 创建 <span class="keyword">admin</span> 网络 image</span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne image admin http://controller:9292</span></span><br><span class="line"> </span><br><span class="line">yum <span class="keyword">install</span> openstack-glance -y</span><br><span class="line"> </span><br><span class="line">cp /etc/glance/glance-api.conf /etc/glance/glance-api.conf.bak</span><br><span class="line">grep -Ev <span class="string">"^$|#"</span> /etc/glance/glance-api.conf.bak &gt; /etc/glance/glance-api.conf</span><br><span class="line"> </span><br><span class="line">vim /etc/glance/glance-api.conf</span><br><span class="line">[<span class="keyword">database</span>]</span><br><span class="line"><span class="keyword">connection</span> = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance</span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri  = <span class="keyword">http</span>://controller:<span class="number">5000</span></span><br><span class="line">auth_url = <span class="keyword">http</span>://controller:<span class="number">5000</span></span><br><span class="line">memcached_servers = controller:<span class="number">11211</span></span><br><span class="line">auth_type = <span class="keyword">password</span></span><br><span class="line">project_domain_name = <span class="keyword">Default</span></span><br><span class="line">user_domain_name = <span class="keyword">Default</span></span><br><span class="line">project_name = service</span><br><span class="line">username = glance</span><br><span class="line"><span class="keyword">password</span> = <span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">[paste_deploy]</span><br><span class="line">flavor = keystone</span><br><span class="line"> </span><br><span class="line">[glance_store]</span><br><span class="line">stores = <span class="keyword">file</span>,<span class="keyword">http</span></span><br><span class="line">default_store = <span class="keyword">file</span></span><br><span class="line">filesystem_store_datadir = /<span class="keyword">var</span>/lib/glance/images/</span><br><span class="line"> </span><br><span class="line">su -s /<span class="keyword">bin</span>/sh -c <span class="string">"glance-manage db_sync"</span> glance</span><br><span class="line"> </span><br><span class="line"><span class="comment">#validate</span></span><br><span class="line">mysql glance -e <span class="string">"show tables;"</span></span><br><span class="line"> </span><br><span class="line">systemctl <span class="keyword">enable</span> openstack-glance-api.service</span><br><span class="line">systemctl <span class="keyword">start</span> openstack-glance-api.service</span><br><span class="line"> </span><br><span class="line">netstat -nltp |grep <span class="number">9292</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">// 创建一个镜像</span><br><span class="line"> </span><br><span class="line">. <span class="keyword">admin</span>-openrc</span><br><span class="line"> </span><br><span class="line"> wget <span class="keyword">http</span>://download.cirros-cloud.net/<span class="number">0.4</span><span class="number">.0</span>/cirros<span class="number">-0.4</span><span class="number">.0</span>-x86_64-disk.img</span><br><span class="line"> </span><br><span class="line">glance image-<span class="keyword">create</span> <span class="comment">--name "cirros" \</span></span><br><span class="line">  <span class="comment">--file cirros-0.4.0-x86_64-disk.img \</span></span><br><span class="line">  <span class="comment">--disk-format qcow2 --container-format bare \</span></span><br><span class="line">  <span class="comment">--visibility public</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#Invalid OpenStack Identity credentials.</span></span><br><span class="line">配置文件密码错误，修改后重启服务</span><br><span class="line"> </span><br><span class="line">glance image-<span class="keyword">list</span></span><br></pre></td></tr></table></figure>
<h3 id="Placement-安装"><a href="#Placement-安装" class="headerlink" title="Placement 安装"></a>Placement 安装</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> placement;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> placement.* <span class="keyword">TO</span> <span class="string">'placement'</span>@<span class="string">'localhost'</span>  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'PLACEMENT_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> placement.* <span class="keyword">TO</span> <span class="string">'placement'</span>@<span class="string">'%'</span>  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'PLACEMENT_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line">. admin-openrc</span><br><span class="line">openstack user <span class="keyword">create</span> <span class="comment">--domain default --password-prompt placement</span></span><br><span class="line"><span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">openstack <span class="keyword">role</span> <span class="keyword">add</span> <span class="comment">--project service --user placement admin</span></span><br><span class="line"> </span><br><span class="line">openstack service <span class="keyword">create</span> <span class="comment">--name placement \</span></span><br><span class="line">  <span class="comment">--description "Placement API" placement</span></span><br><span class="line"> </span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne placement public http://controller:8778</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne placement internal http://controller:8778</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne placement admin http://controller:8778</span></span><br><span class="line"> </span><br><span class="line">yum <span class="keyword">install</span> openstack-placement-api -y</span><br><span class="line">cp /etc/placement/placement.conf /etc/placement/placement.conf.bak</span><br><span class="line">grep -Ev <span class="string">"#|^$"</span> /etc/placement/placement.conf.bak &gt;/etc/placement/placement.conf</span><br><span class="line"> </span><br><span class="line">vim /etc/placement/placement.conf</span><br><span class="line"> </span><br><span class="line">[placement_database]</span><br><span class="line"><span class="keyword">connection</span> = mysql+pymysql://placement:PLACEMENT_DBPASS@controller/placement</span><br><span class="line"> </span><br><span class="line">[api]</span><br><span class="line">auth_strategy = keystone</span><br><span class="line"> </span><br><span class="line">[keystone_authtoken]</span><br><span class="line">auth_url = <span class="keyword">http</span>://controller:<span class="number">5000</span>/v3</span><br><span class="line">memcached_servers = controller:<span class="number">11211</span></span><br><span class="line">auth_type = <span class="keyword">password</span></span><br><span class="line">project_domain_name = <span class="keyword">Default</span></span><br><span class="line">user_domain_name = <span class="keyword">Default</span></span><br><span class="line">project_name = service</span><br><span class="line">username = placement</span><br><span class="line"><span class="keyword">password</span> = <span class="number">123456</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">su -s /<span class="keyword">bin</span>/sh -c <span class="string">"placement-manage db sync"</span> placement</span><br><span class="line"> </span><br><span class="line">/usr/lib/python2<span class="number">.7</span>/site-packages/pymysql/cursors.py:<span class="number">170</span>: <span class="keyword">Warning</span>: (<span class="number">1280</span>, u<span class="string">"Name 'alembic_version_pkc' ignored for PRIMARY key."</span>)</span><br><span class="line">  <span class="keyword">result</span> = self._query(<span class="keyword">query</span>)</span><br><span class="line"> </span><br><span class="line">mysql placement -e <span class="string">"show tables;"</span></span><br><span class="line"> </span><br><span class="line">systemctl restart httpd</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># httpd 报 403 拒绝访问，可以使用 uwsgi 试试</span></span><br><span class="line"><span class="comment">#pip install -i https://pypi.tuna.tsinghua.edu.cn/simple uwsgi</span></span><br><span class="line"><span class="comment">#uwsgi -d -M --http :8778 --wsgi-file /usr/bin/placement-api --processes 2 --threads 10</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">curl -v <span class="keyword">http</span>://controller:<span class="number">8778</span></span><br><span class="line"><span class="comment">#httpd 报 403 拒绝访问</span></span><br><span class="line">AH01630: <span class="keyword">client</span> denied <span class="keyword">by</span> <span class="keyword">server</span> configuration: /usr/<span class="keyword">bin</span>/placement-api</span><br><span class="line"> </span><br><span class="line"> vim /etc/httpd/conf.d/<span class="number">00</span>-placement-api.conf</span><br><span class="line"> </span><br><span class="line">&lt;<span class="keyword">Directory</span> /usr/<span class="keyword">bin</span>&gt;</span><br><span class="line">    &lt;IfVersion &gt;= <span class="number">2.4</span>&gt;</span><br><span class="line">        Require <span class="keyword">all</span> granted</span><br><span class="line">    &lt;/IfVersion&gt;</span><br><span class="line">    &lt;IfVersion &lt; <span class="number">2.4</span>&gt;</span><br><span class="line">        <span class="keyword">Order</span> <span class="keyword">allow</span>,deny</span><br><span class="line">        <span class="keyword">Allow</span> <span class="keyword">from</span> <span class="keyword">all</span></span><br><span class="line">    &lt;/IfVersion&gt;</span><br><span class="line">&lt;/<span class="keyword">Directory</span>&gt;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">. <span class="keyword">admin</span>-openrc</span><br><span class="line"> </span><br><span class="line">placement-<span class="keyword">status</span> <span class="keyword">upgrade</span> <span class="keyword">check</span></span><br><span class="line"> </span><br><span class="line">pip <span class="keyword">install</span> osc-placement</span><br><span class="line"> </span><br><span class="line">openstack <span class="comment">--os-placement-api-version 1.2 resource class list --sort-column name</span></span><br><span class="line"> </span><br><span class="line">openstack <span class="comment">--os-placement-api-version 1.6 trait list --sort-column name</span></span><br></pre></td></tr></table></figure>
<h3 id="Nova-控制节点安装"><a href="#Nova-控制节点安装" class="headerlink" title="Nova 控制节点安装"></a>Nova 控制节点安装</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> nova_api;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> nova;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> nova_cell0;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova_api.* <span class="keyword">TO</span> <span class="string">'nova'</span>@<span class="string">'localhost'</span> \</span><br><span class="line">  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'NOVA_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova_api.* <span class="keyword">TO</span> <span class="string">'nova'</span>@<span class="string">'%'</span> \</span><br><span class="line">  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'NOVA_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova.* <span class="keyword">TO</span> <span class="string">'nova'</span>@<span class="string">'localhost'</span> \</span><br><span class="line">  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'NOVA_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova.* <span class="keyword">TO</span> <span class="string">'nova'</span>@<span class="string">'%'</span> \</span><br><span class="line">  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'NOVA_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova_cell0.* <span class="keyword">TO</span> <span class="string">'nova'</span>@<span class="string">'localhost'</span> \</span><br><span class="line">  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'NOVA_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> nova_cell0.* <span class="keyword">TO</span> <span class="string">'nova'</span>@<span class="string">'%'</span> \</span><br><span class="line">  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'NOVA_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">. admin-openrc</span><br><span class="line">// 创建一个nova 用户</span><br><span class="line">openstack user <span class="keyword">create</span> <span class="comment">--domain default --password-prompt nova</span></span><br><span class="line"><span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">// 创建一个nova 到 <span class="keyword">admin</span> 角色</span><br><span class="line">openstack <span class="keyword">role</span> <span class="keyword">add</span> <span class="comment">--project service --user nova admin</span></span><br><span class="line"> </span><br><span class="line">// <span class="keyword">Create</span> the nova service entity</span><br><span class="line">openstack service <span class="keyword">create</span> <span class="comment">--name nova \</span></span><br><span class="line">  <span class="comment">--description "OpenStack Compute" compute</span></span><br><span class="line"> </span><br><span class="line">// <span class="keyword">Create</span> the <span class="keyword">Compute</span> API service endpoints</span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne compute public http://controller:8774/v2.1</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne compute internal http://controller:8774/v2.1</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne compute admin http://controller:8774/v2.1</span></span><br><span class="line"> </span><br><span class="line">yum <span class="keyword">install</span> openstack-nova-api openstack-nova-conductor \</span><br><span class="line">  openstack-nova-novncproxy openstack-nova-scheduler -y</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">cp /etc/nova/nova.conf /etc/nova/nova.conf.bak</span><br><span class="line">grep -Ev <span class="string">"^$|#"</span> /etc/nova/nova.conf.bak &gt; /etc/nova/nova.conf</span><br><span class="line"> </span><br><span class="line">vim /etc/nova/nova.conf</span><br><span class="line">[<span class="keyword">DEFAULT</span>]</span><br><span class="line">enabled_apis = osapi_compute,metadata</span><br><span class="line">transport_url = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br><span class="line">my_ip = <span class="number">192.168</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">use_neutron = <span class="literal">true</span></span><br><span class="line">firewall_driver = nova.virt.firewall.NoopFirewallDriver</span><br><span class="line"> </span><br><span class="line">[api]</span><br><span class="line">auth_strategy = keystone</span><br><span class="line"> </span><br><span class="line">[api_database]</span><br><span class="line"><span class="keyword">connection</span> = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api</span><br><span class="line"> </span><br><span class="line">[barbican]</span><br><span class="line">[<span class="keyword">cache</span>]</span><br><span class="line">[cinder]</span><br><span class="line">[<span class="keyword">compute</span>]</span><br><span class="line">[conductor]</span><br><span class="line">[console]</span><br><span class="line">[consoleauth]</span><br><span class="line">[cors]</span><br><span class="line">[<span class="keyword">database</span>]</span><br><span class="line"><span class="keyword">connection</span> = mysql+pymysql://nova:NOVA_DBPASS@controller/nova</span><br><span class="line"> </span><br><span class="line">[devices]</span><br><span class="line">[ephemeral_storage_encryption]</span><br><span class="line">[filter_scheduler]</span><br><span class="line">[glance]</span><br><span class="line">api_servers = <span class="keyword">http</span>://controller:<span class="number">9292</span></span><br><span class="line"> </span><br><span class="line">[guestfs]</span><br><span class="line">[healthcheck]</span><br><span class="line">[hyperv]</span><br><span class="line">[ironic]</span><br><span class="line">[key_manager]</span><br><span class="line">[keystone]</span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = <span class="keyword">http</span>://controller:<span class="number">5000</span>/</span><br><span class="line">auth_url = <span class="keyword">http</span>://controller:<span class="number">5000</span>/</span><br><span class="line">memcached_servers = controller:<span class="number">11211</span></span><br><span class="line">auth_type = <span class="keyword">password</span></span><br><span class="line">project_domain_name = <span class="keyword">Default</span></span><br><span class="line">user_domain_name = <span class="keyword">Default</span></span><br><span class="line">project_name = service</span><br><span class="line">username = nova</span><br><span class="line"><span class="keyword">password</span> = <span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">[libvirt]</span><br><span class="line">[metrics]</span><br><span class="line">[mks]</span><br><span class="line">[neutron]</span><br><span class="line">[notifications]</span><br><span class="line">[osapi_v21]</span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = /<span class="keyword">var</span>/lib/nova/tmp</span><br><span class="line"> </span><br><span class="line">[oslo_messaging_amqp]</span><br><span class="line">[oslo_messaging_kafka]</span><br><span class="line">[oslo_messaging_notifications]</span><br><span class="line">[oslo_messaging_rabbit]</span><br><span class="line">[oslo_middleware]</span><br><span class="line">[oslo_policy]</span><br><span class="line">[pci]</span><br><span class="line">[placement]</span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_domain_name = <span class="keyword">Default</span></span><br><span class="line">project_name = service</span><br><span class="line">auth_type = <span class="keyword">password</span></span><br><span class="line">user_domain_name = <span class="keyword">Default</span></span><br><span class="line">auth_url = <span class="keyword">http</span>://controller:<span class="number">5000</span>/v3</span><br><span class="line">username = placement</span><br><span class="line"><span class="keyword">password</span> = <span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">[powervm]</span><br><span class="line">[privsep]</span><br><span class="line">[profiler]</span><br><span class="line">[<span class="keyword">quota</span>]</span><br><span class="line">[rdp]</span><br><span class="line">[remote_debug]</span><br><span class="line">[scheduler]</span><br><span class="line">[serial_console]</span><br><span class="line">[service_user]</span><br><span class="line">[spice]</span><br><span class="line">[upgrade_levels]</span><br><span class="line">[vault]</span><br><span class="line">[vendordata_dynamic_auth]</span><br><span class="line">[vmware]</span><br><span class="line">[vnc]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">server_listen = $my_ip</span><br><span class="line">server_proxyclient_address = $my_ip</span><br><span class="line"> </span><br><span class="line">[workarounds]</span><br><span class="line">[wsgi]</span><br><span class="line">[xenserver]</span><br><span class="line">[xvp]</span><br><span class="line">[zvm]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">su -s /<span class="keyword">bin</span>/sh -c <span class="string">"nova-manage api_db sync"</span> nova</span><br><span class="line"> </span><br><span class="line">mysql nova_api -e <span class="string">"show tables;"</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">Register</span> the cell0 <span class="keyword">database</span></span><br><span class="line">su -s /<span class="keyword">bin</span>/sh -c <span class="string">"nova-manage cell_v2 map_cell0"</span> nova</span><br><span class="line"> </span><br><span class="line"><span class="keyword">Create</span> the cell1 cell</span><br><span class="line">su -s /<span class="keyword">bin</span>/sh -c <span class="string">"nova-manage cell_v2 create_cell --name=cell1 --verbose"</span> nova</span><br><span class="line"> </span><br><span class="line">Populate the nova <span class="keyword">database</span></span><br><span class="line">su -s /<span class="keyword">bin</span>/sh -c <span class="string">"nova-manage db sync"</span> nova<span class="string">'</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">Verify nova cell0 and cell1 are registered correctly</span></span><br><span class="line"><span class="string">su -s /bin/sh -c "nova-manage cell_v2 list_cells" nova</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">#validate</span></span><br><span class="line"><span class="string">mysql nova -e "show tables;"</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">systemctl enable \</span></span><br><span class="line"><span class="string">    openstack-nova-api.service \</span></span><br><span class="line"><span class="string">    openstack-nova-scheduler.service \</span></span><br><span class="line"><span class="string">    openstack-nova-conductor.service \</span></span><br><span class="line"><span class="string">    openstack-nova-novncproxy.service</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">systemctl start \</span></span><br><span class="line"><span class="string">    openstack-nova-api.service \</span></span><br><span class="line"><span class="string">    openstack-nova-scheduler.service \</span></span><br><span class="line"><span class="string">    openstack-nova-conductor.service \</span></span><br><span class="line"><span class="string">    openstack-nova-novncproxy.service</span></span><br></pre></td></tr></table></figure>
<h3 id="Neutron-控制节点安装"><a href="#Neutron-控制节点安装" class="headerlink" title="Neutron 控制节点安装"></a>Neutron 控制节点安装</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line"> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> neutron;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> neutron.* <span class="keyword">TO</span> <span class="string">'neutron'</span>@<span class="string">'localhost'</span> \</span><br><span class="line">  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'NEUTRON_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> neutron.* <span class="keyword">TO</span> <span class="string">'neutron'</span>@<span class="string">'%'</span> \</span><br><span class="line">  <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'NEUTRON_DBPASS'</span>;</span><br><span class="line"> </span><br><span class="line">. admin-openrc</span><br><span class="line">// <span class="keyword">Create</span> the neutron <span class="keyword">user</span></span><br><span class="line">openstack <span class="keyword">user</span> <span class="keyword">create</span> <span class="comment">--domain default --password-prompt neutron</span></span><br><span class="line"><span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">// <span class="keyword">Add</span> the <span class="keyword">admin</span> <span class="keyword">role</span> <span class="keyword">to</span> the neutron <span class="keyword">user</span></span><br><span class="line">openstack <span class="keyword">role</span> <span class="keyword">add</span> <span class="comment">--project service --user neutron admin</span></span><br><span class="line"> </span><br><span class="line">// <span class="keyword">Create</span> the neutron service entity</span><br><span class="line">openstack service <span class="keyword">create</span> <span class="comment">--name neutron \</span></span><br><span class="line">  <span class="comment">--description "OpenStack Networking" network</span></span><br><span class="line"> </span><br><span class="line">// <span class="keyword">Create</span> the Networking service API endpoints</span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne network public http://controller:9696</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne network internal http://controller:9696</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne network admin http://controller:9696</span></span><br><span class="line"> </span><br><span class="line">// linux bridge 支持</span><br><span class="line">lsmod |grep br_netfilter</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"> </span><br><span class="line">sysctl -a |grep <span class="string">"net.bridge.bridge"</span></span><br><span class="line">echo <span class="string">"modprobe br_netfilter"</span> &gt;/etc/sysconfig/modules/br_netfilter.modules</span><br><span class="line"> </span><br><span class="line">sysctl -a |grep net.bridge.bridge-nf-<span class="keyword">call</span>-iptables</span><br><span class="line">sysctl -a |grep net.bridge.bridge-nf-<span class="keyword">call</span>-ip6tables</span><br><span class="line"> </span><br><span class="line">// 选择其中一个网络类型安装</span><br><span class="line">//  非路由模式</span><br><span class="line">Networking <span class="keyword">Option</span> <span class="number">1</span>: Provider networks</span><br><span class="line">// 路由模式</span><br><span class="line">Networking <span class="keyword">Option</span> <span class="number">2</span>: <span class="keyword">Self</span>-service networks</span><br><span class="line"> </span><br><span class="line">// 配置元数据代理</span><br><span class="line">vim /etc/neutron/metadata_agent.ini</span><br><span class="line">[<span class="keyword">DEFAULT</span>]</span><br><span class="line">nova_metadata_host = controller</span><br><span class="line">metadata_proxy_shared_secret = METADATA_SECRET</span><br><span class="line"> </span><br><span class="line">vim /etc/nova/nova.conf</span><br><span class="line">[neutron]</span><br><span class="line">auth_url = <span class="keyword">http</span>://controller:<span class="number">5000</span></span><br><span class="line">auth_type = <span class="keyword">password</span></span><br><span class="line">project_domain_name = <span class="keyword">default</span></span><br><span class="line">user_domain_name = <span class="keyword">default</span></span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line"><span class="keyword">password</span> = NEUTRON_PASS</span><br><span class="line">service_metadata_proxy = <span class="literal">true</span></span><br><span class="line">metadata_proxy_shared_secret = METADATA_SECRET</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \</span></span><br><span class="line">  <span class="comment">--config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># systemctl restart openstack-nova-api.service</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># systemctl enable neutron-server.service \</span></span><br><span class="line">  neutron-linuxbridge-agent.service \</span><br><span class="line">    neutron-dhcp-agent.service \</span><br><span class="line">  neutron-metadata-agent.service</span><br><span class="line"> </span><br><span class="line"><span class="comment"># systemctl start neutron-server.service \</span></span><br><span class="line">  neutron-linuxbridge-agent.service \</span><br><span class="line">    neutron-dhcp-agent.service \</span><br><span class="line">  neutron-metadata-agent.service</span><br><span class="line"> </span><br><span class="line">// 选择路由模式后执行</span><br><span class="line"><span class="comment"># systemctl enable neutron-l3-agent.service</span></span><br><span class="line"><span class="comment"># systemctl start neutron-l3-agent.service</span></span><br><span class="line"> </span><br><span class="line">neutron <span class="keyword">agent</span>-<span class="keyword">list</span></span><br></pre></td></tr></table></figure>
<h3 id="网络类型分为：桥接型，路由型两种，安装方式也不同。"><a href="#网络类型分为：桥接型，路由型两种，安装方式也不同。" class="headerlink" title="网络类型分为：桥接型，路由型两种，安装方式也不同。"></a>网络类型分为：桥接型，路由型两种，安装方式也不同。</h3><h4 id="桥接型"><a href="#桥接型" class="headerlink" title="桥接型"></a>桥接型</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">yum install openstack-neutron openstack-neutron-ml2 \</span><br><span class="line">  openstack-neutron-linuxbridge ebtables -y</span><br><span class="line"> </span><br><span class="line">cp  <span class="regexp">/etc/</span>neutron<span class="regexp">/neutron.conf  /</span>etc<span class="regexp">/neutron/</span>neutron.conf.bak</span><br><span class="line">grep -Ev <span class="string">"#|^$"</span> <span class="regexp">/etc/</span>neutron<span class="regexp">/neutron.conf.bak &gt;/</span>etc<span class="regexp">/neutron/</span>neutron.conf</span><br><span class="line"> </span><br><span class="line">vim <span class="regexp">/etc/</span>neutron/neutron.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">core_plugin = ml2</span><br><span class="line">service_plugins =</span><br><span class="line">auth_strategy = keystone</span><br><span class="line">notify_nova_on_port_status_changes = <span class="literal">true</span></span><br><span class="line">notify_nova_on_port_data_changes = <span class="literal">true</span></span><br><span class="line"> </span><br><span class="line">[database]</span><br><span class="line">connection = mysql+<span class="string">pymysql:</span><span class="comment">//neutron:NEUTRON_DBPASS@controller/neutron</span></span><br><span class="line"> </span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = <span class="string">http:</span><span class="comment">//controller:5000</span></span><br><span class="line">auth_url = <span class="string">http:</span><span class="comment">//controller:5000</span></span><br><span class="line">memcached_servers = <span class="string">controller:</span><span class="number">11211</span></span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = <span class="keyword">default</span></span><br><span class="line">user_domain_name = <span class="keyword">default</span></span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = <span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">[nova]</span><br><span class="line">auth_url = <span class="string">http:</span><span class="comment">//controller:5000</span></span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = <span class="keyword">default</span></span><br><span class="line">user_domain_name = <span class="keyword">default</span></span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_name = service</span><br><span class="line">username = nova</span><br><span class="line">password = <span class="number">123456</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">cp <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/</span>ml2<span class="regexp">/ml2_conf.ini /</span>etc<span class="regexp">/neutron/</span>plugins<span class="regexp">/ml2/</span>ml2_conf.ini.bak</span><br><span class="line">grep -Ev <span class="string">"#|^$"</span> <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/</span>ml2<span class="regexp">/ml2_conf.ini.bak &gt;/</span>etc<span class="regexp">/neutron/</span>plugins<span class="regexp">/ml2/</span>ml2_conf.ini</span><br><span class="line"> </span><br><span class="line">vim <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/</span>ml2/ml2_conf.ini</span><br><span class="line">[ml2]</span><br><span class="line">type_drivers = flat,vlan</span><br><span class="line">tenant_network_types =</span><br><span class="line">mechanism_drivers = linuxbridge</span><br><span class="line">extension_drivers = port_security</span><br><span class="line">[ml2_type_flat]</span><br><span class="line">flat_networks = provider</span><br><span class="line">[securitygroup]</span><br><span class="line">enable_ipset = <span class="literal">true</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">cp <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/</span>ml2<span class="regexp">/linuxbridge_agent.ini /</span>etc<span class="regexp">/neutron/</span>plugins<span class="regexp">/ml2/</span>linuxbridge_agent.ini.bak</span><br><span class="line">grep -Ev <span class="string">"#|^$"</span> <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/</span>ml2<span class="regexp">/linuxbridge_agent.ini.bak &gt;/</span>etc<span class="regexp">/neutron/</span>plugins<span class="regexp">/ml2/</span>linuxbridge_agent.ini</span><br><span class="line"> </span><br><span class="line">vim <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/</span>ml2/linuxbridge_agent.ini</span><br><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = <span class="string">provider:</span>eth0</span><br><span class="line">[vxlan]</span><br><span class="line">enable_vxlan = <span class="literal">false</span></span><br><span class="line">[securitygroup]</span><br><span class="line">enable_security_group = <span class="literal">true</span></span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br><span class="line"> </span><br><span class="line">cp <span class="regexp">/etc/</span>neutron<span class="regexp">/dhcp_agent.ini /</span>etc<span class="regexp">/neutron/</span>dhcp_agent.ini.bak</span><br><span class="line">grep -Ev <span class="string">"#|^$"</span> <span class="regexp">/etc/</span>neutron<span class="regexp">/dhcp_agent.ini.bak &gt;/</span>etc<span class="regexp">/neutron/</span>dhcp_agent.ini</span><br><span class="line">vim <span class="regexp">/etc/</span>neutron/dhcp_agent.ini</span><br><span class="line"> </span><br><span class="line">[DEFAULT]</span><br><span class="line">interface_driver = linuxbridge</span><br><span class="line">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq</span><br><span class="line">enable_isolated_metadata = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="路由型"><a href="#路由型" class="headerlink" title="路由型"></a>路由型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Worker-节点安装"><a href="#Worker-节点安装" class="headerlink" title="Worker 节点安装"></a>Worker 节点安装</h2><h3 id="Nova-组件"><a href="#Nova-组件" class="headerlink" title="Nova 组件"></a>Nova 组件</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">yum -y install centos-release-openstack-train</span><br><span class="line"> </span><br><span class="line">yum install openstack-nova-compute -y</span><br><span class="line"> </span><br><span class="line">cp /etc/nova/nova.conf /etc/nova/nova.conf.bak</span><br><span class="line">grep -Ev <span class="string">"#|^$"</span> /etc/nova/nova.conf.bak &gt;/etc/nova/nova.conf</span><br><span class="line"> </span><br><span class="line">vim /etc/nova/nova.conf</span><br><span class="line">[<span class="meta">DEFAULT</span>]</span><br><span class="line">enabled_apis = osapi_compute,metadata</span><br><span class="line">transport_url = rabbit:<span class="comment">//openstack:RABBIT_PASS@controller</span></span><br><span class="line">my_ip = <span class="number">192.168</span><span class="number">.0</span><span class="number">.104</span></span><br><span class="line">use_neutron = <span class="literal">true</span></span><br><span class="line">firewall_driver = nova.virt.firewall.NoopFirewallDriver</span><br><span class="line"> </span><br><span class="line">[<span class="meta">api</span>]</span><br><span class="line">auth_strategy = keystone</span><br><span class="line"> </span><br><span class="line">[<span class="meta">api_database</span>]</span><br><span class="line">[<span class="meta">barbican</span>]</span><br><span class="line">[<span class="meta">cache</span>]</span><br><span class="line">[<span class="meta">cinder</span>]</span><br><span class="line">[<span class="meta">compute</span>]</span><br><span class="line">[<span class="meta">conductor</span>]</span><br><span class="line">[<span class="meta">console</span>]</span><br><span class="line">[<span class="meta">consoleauth</span>]</span><br><span class="line">[<span class="meta">cors</span>]</span><br><span class="line">[<span class="meta">database</span>]</span><br><span class="line">[<span class="meta">devices</span>]</span><br><span class="line">[<span class="meta">ephemeral_storage_encryption</span>]</span><br><span class="line">[<span class="meta">filter_scheduler</span>]</span><br><span class="line">[<span class="meta">glance</span>]</span><br><span class="line">api_servers = http:<span class="comment">//controller:9292</span></span><br><span class="line"> </span><br><span class="line">[<span class="meta">guestfs</span>]</span><br><span class="line">[<span class="meta">healthcheck</span>]</span><br><span class="line">[<span class="meta">hyperv</span>]</span><br><span class="line">[<span class="meta">ironic</span>]</span><br><span class="line">[<span class="meta">key_manager</span>]</span><br><span class="line">[<span class="meta">keystone</span>]</span><br><span class="line">[<span class="meta">keystone_authtoken</span>]</span><br><span class="line">www_authenticate_uri = http:<span class="comment">//controller:5000/</span></span><br><span class="line">auth_url = http:<span class="comment">//controller:5000/</span></span><br><span class="line">memcached_servers = controller:<span class="number">11211</span></span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = nova</span><br><span class="line">password = <span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">[<span class="meta">libvirt</span>]</span><br><span class="line">virt_type = qemu</span><br><span class="line">[<span class="meta">metrics</span>]</span><br><span class="line">[<span class="meta">mks</span>]</span><br><span class="line">[<span class="meta">neutron</span>]</span><br><span class="line">[<span class="meta">notifications</span>]</span><br><span class="line">[<span class="meta">osapi_v21</span>]</span><br><span class="line">[<span class="meta">oslo_concurrency</span>]</span><br><span class="line">lock_path = /<span class="keyword">var</span>/lib/nova/tmp</span><br><span class="line"> </span><br><span class="line">[<span class="meta">oslo_messaging_amqp</span>]</span><br><span class="line">[<span class="meta">oslo_messaging_kafka</span>]</span><br><span class="line">[<span class="meta">oslo_messaging_notifications</span>]</span><br><span class="line">[<span class="meta">oslo_messaging_rabbit</span>]</span><br><span class="line">[<span class="meta">oslo_middleware</span>]</span><br><span class="line">[<span class="meta">oslo_policy</span>]</span><br><span class="line">[<span class="meta">pci</span>]</span><br><span class="line">[<span class="meta">placement</span>]</span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">auth_type = password</span><br><span class="line">user_domain_name = Default</span><br><span class="line">auth_url = http:<span class="comment">//controller:5000/v3</span></span><br><span class="line">username = placement</span><br><span class="line">password = <span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">[<span class="meta">powervm</span>]</span><br><span class="line">[<span class="meta">privsep</span>]</span><br><span class="line">[<span class="meta">profiler</span>]</span><br><span class="line">[<span class="meta">quota</span>]</span><br><span class="line">[<span class="meta">rdp</span>]</span><br><span class="line">[<span class="meta">remote_debug</span>]</span><br><span class="line">[<span class="meta">scheduler</span>]</span><br><span class="line">[<span class="meta">serial_console</span>]</span><br><span class="line">[<span class="meta">service_user</span>]</span><br><span class="line">[<span class="meta">spice</span>]</span><br><span class="line">[<span class="meta">upgrade_levels</span>]</span><br><span class="line">[<span class="meta">vault</span>]</span><br><span class="line">[<span class="meta">vendordata_dynamic_auth</span>]</span><br><span class="line">[<span class="meta">vmware</span>]</span><br><span class="line">[<span class="meta">vnc</span>]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">server_listen = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">server_proxyclient_address = $my_ip</span><br><span class="line">novncproxy_base_url = http:<span class="comment">//controller:6080/vnc_auto.html</span></span><br><span class="line"> </span><br><span class="line">[<span class="meta">workarounds</span>]</span><br><span class="line">[<span class="meta">wsgi</span>]</span><br><span class="line">[<span class="meta">xenserver</span>]</span><br><span class="line">[<span class="meta">xvp</span>]</span><br><span class="line">[<span class="meta">zvm</span>]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">egrep -c <span class="string">'(vmx|svm)'</span> /proc/cpuinfo</span><br><span class="line">systemctl enable libvirtd.service openstack-nova-compute.service</span><br><span class="line">systemctl start libvirtd.service openstack-nova-compute.service</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Failed to connect socket to <span class="string">'/var/run/libvirt/libvirt-sock'</span>: Permission denied: libvirtError: Failed to connect socket to <span class="string">'/var/run/libvirt/libvirt-sock'</span>: Permission denied</span><br><span class="line"> </span><br><span class="line">chmod <span class="number">777</span> /<span class="keyword">var</span>/run/libvirt/libvirt-sock</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Run the following commands <span class="keyword">on</span> the controller node.</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 查看主机</span></span><br><span class="line">. admin-openrc</span><br><span class="line">openstack compute service list --service nova-compute</span><br><span class="line"> </span><br><span class="line">Discover compute hosts</span><br><span class="line">su -s /bin/sh -c <span class="string">"nova-manage cell_v2 discover_hosts --verbose"</span> nova</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 自动发现 controller 配置</span></span><br><span class="line">vim /etc/nova/nova.conf</span><br><span class="line">[<span class="meta">scheduler</span>]</span><br><span class="line">discover_hosts_in_cells_interval = <span class="number">120</span></span><br><span class="line"> </span><br><span class="line">openstack user list</span><br><span class="line">openstack service list</span><br><span class="line">openstack role list</span><br><span class="line"> </span><br><span class="line">openstack service list</span><br><span class="line">openstack compute service list</span><br><span class="line">openstack catalog list</span><br><span class="line">openstack image list</span><br><span class="line">nova-status upgrade check</span><br></pre></td></tr></table></figure>
<h3 id="Neutron-组件"><a href="#Neutron-组件" class="headerlink" title="Neutron 组件"></a>Neutron 组件</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">yum install openstack-neutron-linuxbridge ebtables ipset -y</span><br><span class="line"> </span><br><span class="line">cp <span class="regexp">/etc/</span>neutron<span class="regexp">/neutron.conf /</span>etc<span class="regexp">/neutron/</span>neutron.conf.bak</span><br><span class="line">grep -Ev <span class="string">"#|^$"</span> <span class="regexp">/etc/</span>neutron<span class="regexp">/neutron.conf.bak &gt;/</span>etc<span class="regexp">/neutron/</span>neutron.conf</span><br><span class="line"> </span><br><span class="line">vim <span class="regexp">/etc/</span>neutron/neutron.conf</span><br><span class="line">[DEFAULT]</span><br><span class="line">transport_url = <span class="string">rabbit:</span><span class="comment">//openstack:RABBIT_PASS@controller</span></span><br><span class="line">auth_strategy = keystone</span><br><span class="line"> </span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri = <span class="string">http:</span><span class="comment">//controller:5000</span></span><br><span class="line">auth_url = <span class="string">http:</span><span class="comment">//controller:5000</span></span><br><span class="line">memcached_servers = <span class="string">controller:</span><span class="number">11211</span></span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = <span class="keyword">default</span></span><br><span class="line">user_domain_name = <span class="keyword">default</span></span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = <span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">[oslo_concurrency]</span><br><span class="line">lock_path = <span class="regexp">/var/</span>lib<span class="regexp">/neutron/</span>tmp</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">cp <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/</span>ml2<span class="regexp">/linuxbridge_agent.ini /</span>etc<span class="regexp">/neutron/</span>plugins<span class="regexp">/ml2/</span>linuxbridge_agent.ini.bak</span><br><span class="line">grep -Ev <span class="string">"#|^$"</span> <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/</span>ml2<span class="regexp">/linuxbridge_agent.ini.bak &gt;/</span>etc<span class="regexp">/neutron/</span>plugins<span class="regexp">/ml2/</span>linuxbridge_agent.ini</span><br><span class="line"> </span><br><span class="line">vim <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/</span>ml2/linuxbridge_agent.ini</span><br><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = <span class="string">provider:</span>em1</span><br><span class="line"> </span><br><span class="line">[vxlan]</span><br><span class="line">enable_vxlan = <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line">[securitygroup]</span><br><span class="line">enable_security_group = <span class="literal">true</span></span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">vim <span class="regexp">/etc/</span>nova/nova.conf</span><br><span class="line">[neutron]</span><br><span class="line">auth_url = <span class="string">http:</span><span class="comment">//controller:5000</span></span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = <span class="keyword">default</span></span><br><span class="line">user_domain_name = <span class="keyword">default</span></span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = <span class="number">123456</span></span><br><span class="line"> </span><br><span class="line">systemctl restart openstack-nova-compute.service</span><br><span class="line"> </span><br><span class="line">systemctl enable neutron-linuxbridge-agent.service</span><br><span class="line">systemctl start neutron-linuxbridge-agent.service</span><br></pre></td></tr></table></figure>
<p>至此，已经可以把 Openstack 跑起来了。接下来要安装一些额外的组件，提供更多的功能。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanqi.cf/2020/05/OpenStack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yan qi">
      <meta itemprop="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blyanqi@163.com">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/OpenStack/" class="post-title-link" itemprop="url">OpenStack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-14 08:40:41" itemprop="dateCreated datePublished" datetime="2020-05-14T08:40:41+08:00">2020-05-14</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanqi.cf/2020/05/KVM%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yan qi">
      <meta itemprop="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blyanqi@163.com">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/KVM%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">KVM 维护</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-14 08:40:29" itemprop="dateCreated datePublished" datetime="2020-05-14T08:40:29+08:00">2020-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-04 11:46:38" itemprop="dateModified" datetime="2020-06-04T11:46:38+08:00">2020-06-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">虚拟化</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="KVM-维护"><a href="#KVM-维护" class="headerlink" title="KVM 维护"></a>KVM 维护</h2><a href="/2020/05/KVM%E5%AE%89%E8%A3%85/" title="KVM安装">KVM安装</a>
<h3 id="修改虚拟机内存，cpu-core"><a href="#修改虚拟机内存，cpu-core" class="headerlink" title="修改虚拟机内存，cpu core"></a>修改虚拟机内存，cpu core</h3><blockquote>
<p>扩大内存，cpu个数需要重启生效</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出虚拟机</span></span><br><span class="line">virsh list --<span class="built_in">help</span></span><br><span class="line">virsh list</span><br><span class="line">virsh list -all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">virsh edit yfgitlab</span><br><span class="line">---</span><br><span class="line">&lt;memory unit=<span class="string">'KiB'</span>&gt;16777216&lt;/memory&gt;</span><br><span class="line">&lt;currentMemory unit=<span class="string">'KiB'</span>&gt;16777216&lt;/currentMemory&gt;</span><br><span class="line">&lt;vcpu placement=<span class="string">'static'</span>&gt;4&lt;/vcpu&gt;</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启虚拟机</span></span><br><span class="line">virsh reboot yfgitlab</span><br><span class="line">or</span><br><span class="line">virsh shutdown yfgitlab</span><br><span class="line">virsh start yfgitlab</span><br></pre></td></tr></table></figure>
<h2 id="动态调整（虚拟机内存，cpu-core）"><a href="#动态调整（虚拟机内存，cpu-core）" class="headerlink" title="动态调整（虚拟机内存，cpu core）"></a>动态调整（虚拟机内存，cpu core）</h2><blockquote>
<p>KVM虚拟机可以动态增加和删除vCPU，但是前提条件是，必须在虚拟机offline模式下先设置好最大vCPU数量。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 调整内存</span></span><br><span class="line">virsh setmaxmem devstack 32G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调整cpu core</span></span><br><span class="line">virsh setvcpus devstack 4</span><br><span class="line"><span class="comment"># error: unsupported configuration: failed to find appropriate hotpluggable vcpus to reach the desired target vcpu count</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="创建快照"><a href="#创建快照" class="headerlink" title="创建快照"></a>创建快照</h3><blockquote>
<p>raw 格式盘不支持快照</p>
</blockquote>
<h2 id><a href="#" class="headerlink" title></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出当前快照</span></span><br><span class="line">virsh snapshot-list yfgitlab</span><br><span class="line"></span><br><span class="line"><span class="comment"># virsh snapshot-create-as 虚拟机名称     快照名称     快照描述</span></span><br><span class="line">virsh snapshot-create-as yfgitlab yfgitlab`date <span class="string">"+%F_%T"</span>` <span class="string">"test"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 还原快照</span></span><br><span class="line">virsh snapshot-revert --domain yfgitlab yfgitlab2017-05-21_08:34:12</span><br></pre></td></tr></table></figure></h2><h3 id="KVM-添加磁盘"><a href="#KVM-添加磁盘" class="headerlink" title="KVM 添加磁盘"></a>KVM 添加磁盘</h3><a href="/2020/05/LVM%E9%80%BB%E8%BE%91%E5%8D%B7%E7%AE%A1%E7%90%86/" title="LVM逻辑卷管理">LVM逻辑卷管理</a>
<blockquote>
<p>qcow2是集各种技术为一体的超级镜像格式，支持内部快照，加密，压缩等一系列功能，访问性能也在不断提高。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建磁盘</span></span><br><span class="line">qemu-img create -h</span><br><span class="line">qemu-img create -f qcow2 yfgitlab2.img 50G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看磁盘格式</span></span><br><span class="line">file hello_data.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 磁盘格式转换 （raw 占用磁盘空间，qcow2 不占用磁盘空间）</span></span><br><span class="line">qemu-img convert -p -t directsync -O qcow2 test.raw test.qcow2 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出虚拟机</span></span><br><span class="line">virsh list</span><br><span class="line">---</span><br><span class="line"> 11    yfgitlab                       running</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="comment"># 磁盘挂到虚拟机</span></span><br><span class="line"><span class="comment"># virsh 添加磁盘   虚拟机名           磁盘位置             虚拟机中盘名  是否缓存</span></span><br><span class="line">virsh attach-disk yfgitlab /data/img1/yfgitlab-data.img vdb --cache none --subdriver=qcow2</span><br><span class="line">virsh attach-disk yfgitlab /data/img1/yfgitlab-data.img vdb --cache none --subdriver=qcow2 --config</span><br><span class="line"></span><br><span class="line">--config   会把文件写入配置文件（下次启动有效）</span><br><span class="line">--live     直接有效</span><br><span class="line">--current  当前有效</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置文件</span></span><br><span class="line"><span class="comment"># /etc/libvirt/qemu/yfgitlab.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载磁盘</span></span><br><span class="line">virsh detach-disk yfgitlab /data/img1/yfgitlab-data.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 到虚拟机中查看磁盘</span></span><br><span class="line">fdisk -l</span><br><span class="line">---</span><br><span class="line">Disk /dev/vdb: 53.7 GB, 53695545344 bytes, 104874112 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式化</span></span><br><span class="line">mkfs.ext4 /dev/vdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载目录</span></span><br><span class="line">mkdir /data</span><br><span class="line">mount /dev/vdb /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">df -h</span><br><span class="line">---</span><br><span class="line">/dev/vdb                  50G   53M   47G   1% /data</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写到挂载文件 /etc/fstab</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/dev/vdb /data ext4 defaults 0 0"</span> &gt;&gt;/etc/fstab</span><br><span class="line">mount -a</span><br></pre></td></tr></table></figure>
<h3 id="KVM-扩磁盘大小"><a href="#KVM-扩磁盘大小" class="headerlink" title="KVM 扩磁盘大小"></a>KVM 扩磁盘大小</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看磁盘格式</span></span><br><span class="line">file hello_data.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看磁盘信息</span></span><br><span class="line">qemu-img info hello_data.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭虚拟机</span></span><br><span class="line">virsh shutdown xp_4_test</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩容磁盘文件</span></span><br><span class="line">qemu-img resize hello_data.img +150M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 缩容</span></span><br><span class="line">qemu-img resize hello_data.img -150M --shrink</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看磁盘信息</span></span><br><span class="line">qemu-img info hello_data.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动虚拟机</span></span><br><span class="line">virsh start xp_4_test</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanqi.cf/2020/05/Docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yan qi">
      <meta itemprop="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blyanqi@163.com">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/Docker/" class="post-title-link" itemprop="url">Docker 使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-14 08:40:25" itemprop="dateCreated datePublished" datetime="2020-05-14T08:40:25+08:00">2020-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-08 18:47:56" itemprop="dateModified" datetime="2020-06-08T18:47:56+08:00">2020-06-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">容器技术</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><ul>
<li><a href="https://www.redhat.com/zh/topics/containers/whats-a-linux-container" target="_blank" rel="noopener">容器原理</a></li>
<li><a href="https://docs.docker.com/engine/" target="_blank" rel="noopener">docker doc </a></li>
<li><a href="https://docs.docker.com/reference/" target="_blank" rel="noopener">docker 参考文档</a></li>
<li><a href="https://container-registry.oracle.com" target="_blank" rel="noopener">oracle 镜像库</a></li>
</ul>
<a href="/2020/05/Docker%E5%AE%89%E8%A3%85/" title="Docker安装">Docker安装</a>
<h2 id="Docker-维护"><a href="#Docker-维护" class="headerlink" title="Docker 维护"></a>Docker 维护</h2><ul>
<li>镜像<ul>
<li>使用 Dockerfile 制作镜像</li>
<li>使用 tag 制作新的镜像</li>
<li>使用 commit 把容器制作成镜像</li>
<li>公共的镜像仓库</li>
<li>使用 harbor 搭建私有镜像仓库</li>
</ul>
</li>
<li>容器<ul>
<li>使用 docker run 创建容器  </li>
<li>使用 docker-compose 进行编排容器<ul>
<li>compose file 格式</li>
</ul>
</li>
</ul>
</li>
<li><p>overlay文件系统</p>
</li>
<li><p>CLI 使用</p>
</li>
<li><p>API 使用</p>
</li>
</ul>
<h2 id="Docker-原理"><a href="#Docker-原理" class="headerlink" title="Docker 原理"></a>Docker 原理</h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># docker Namespaces 隔离</span></span><br><span class="line"><span class="meta"># </span></span><br><span class="line"></span><br><span class="line"><span class="meta"># docker 四种网络模式</span></span><br><span class="line"><span class="meta"># host</span></span><br><span class="line"><span class="meta"># contianer</span></span><br><span class="line"><span class="meta"># none</span></span><br><span class="line"><span class="meta"># bridge</span></span><br></pre></td></tr></table></figure>
<h3 id="docker-容器修改"><a href="#docker-容器修改" class="headerlink" title="docker 容器修改"></a>docker 容器修改</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置文件修改</span></span><br><span class="line"><span class="comment">## 获取id</span></span><br><span class="line">docker inspect e32ee41a614b |grep -i id</span><br><span class="line"></span><br><span class="line"><span class="comment">## mac 系统中使用轻量级虚拟机 hyperkit</span></span><br><span class="line">/var/lib/docker/containers/[hash_of_the_container]/hostconfig.json</span><br></pre></td></tr></table></figure>
<h3 id="docker-容器镜像导出导入"><a href="#docker-容器镜像导出导入" class="headerlink" title="docker 容器镜像导出导入"></a>docker 容器镜像导出导入</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看容器ID</span></span><br><span class="line">docker ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出容器镜像</span></span><br><span class="line">docker <span class="built_in">export</span> 容器ID &gt; container`date <span class="string">"%F_%T"</span>`.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入容器镜像</span></span><br><span class="line">docker import - 镜像名 &lt; container.tar</span><br></pre></td></tr></table></figure>
<h3 id="docker-镜像导出导入"><a href="#docker-镜像导出导入" class="headerlink" title="docker 镜像导出导入"></a>docker 镜像导出导入</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 查看镜像</span></span><br><span class="line">docker image ls</span><br><span class="line">or (old version)</span><br><span class="line">docker images </span><br><span class="line"></span><br><span class="line"><span class="meta"># 导出镜像</span></span><br><span class="line">docker save 镜像ID &gt; image`date <span class="string">"%F_%T"</span>`.tar</span><br><span class="line"></span><br><span class="line"><span class="meta"># 同时打包多个镜像</span></span><br><span class="line">docker save -o images.tar postgres:<span class="number">9.6</span> mongo:<span class="number">3.4</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 导入镜像</span></span><br><span class="line">docker load &lt; image`date <span class="string">"%F_%T"</span>`.tar</span><br><span class="line"></span><br><span class="line"><span class="meta"># 打上tag</span></span><br><span class="line"><span class="meta">#           镜像ID            repo        :tag</span></span><br><span class="line">docker tag <span class="number">21</span>de6f73b9ac sameersbn/gitlab:<span class="number">8.14</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>
<h3 id="通过-registry-来进行镜像同步"><a href="#通过-registry-来进行镜像同步" class="headerlink" title="通过 registry 来进行镜像同步"></a>通过 registry 来进行镜像同步</h3><a href="/2020/05/Harbor%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/" title="Harbor安装配置">Harbor安装配置</a>
<hr>
<h3 id="Docker-使用"><a href="#Docker-使用" class="headerlink" title="Docker 使用"></a>Docker 使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker help</span></span><br><span class="line"><span class="comment"># docker image help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索镜像</span></span><br><span class="line">docker search busybox</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去镜像库拉镜像</span></span><br><span class="line">docker image pull busybox</span><br><span class="line">docker image ls</span><br><span class="line">docker image inspect busybox</span><br><span class="line">docker image create -d --name b1 busybox</span><br><span class="line">docker container ps -a</span><br><span class="line">docker container start b1</span><br><span class="line">docker container <span class="built_in">exec</span> -it b1 /bin/bash</span><br><span class="line">docker container logs b1</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">docker container run --name b1 -it busybox</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看本地镜像</span></span><br><span class="line">docker image ls</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看运行的容器</span></span><br><span class="line">docker container ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器信息</span></span><br><span class="line">docker container inspect b1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有容器</span></span><br><span class="line">docker container ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除容器</span></span><br><span class="line">docker rm b1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 强制删除容器</span></span><br><span class="line">docker container rm b13c1f94e78c --force</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次删除所有容器</span></span><br><span class="line">docker container prune</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">docker logs b1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 交互状态进入容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it b1 /bin/sh</span><br><span class="line"><span class="comment"># or 新式命令</span></span><br><span class="line">docker container <span class="built_in">exec</span> -it b1 /bin/sh</span><br></pre></td></tr></table></figure>
<h2 id="增加一个docker-没有指令（查看tags-版本）"><a href="#增加一个docker-没有指令（查看tags-版本）" class="headerlink" title="增加一个docker 没有指令（查看tags 版本）"></a>增加一个docker 没有指令（查看tags 版本）</h2><blockquote>
<p>网上找了一段shell，我给加了个缓存。官方怎么就没考虑这个需求</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;<span class="string">'EOF'</span> &gt;dockertags</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">usage</span></span>() &#123;</span><br><span class="line">cat &lt;&lt; HELP</span><br><span class="line"></span><br><span class="line">dockertags  --  list all tags <span class="keyword">for</span> a Docker image on a remote registry.</span><br><span class="line"></span><br><span class="line">EXAMPLE:</span><br><span class="line">    - list all tags <span class="keyword">for</span> ubuntu:</span><br><span class="line">       dockertags ubuntu</span><br><span class="line"></span><br><span class="line">    - list all php tags containing apache:</span><br><span class="line">       dockertags php apache</span><br><span class="line"></span><br><span class="line">	- clean cache</span><br><span class="line">       dockertags clean</span><br><span class="line"></span><br><span class="line">HELP</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 增加个缓存，防止重复请求</span></span><br><span class="line"><span class="function"><span class="title">cache</span></span>()&#123;</span><br><span class="line">	mkdir -p <span class="variable">$HOME</span>/.dockercache</span><br><span class="line">	<span class="keyword">if</span> [ -f <span class="variable">$HOME</span>/.dockercache/<span class="variable">$1</span> ];<span class="keyword">then</span></span><br><span class="line">		cat <span class="variable">$HOME</span>/.dockercache/<span class="variable">$1</span>|egrep <span class="string">"<span class="variable">$2</span>.*"</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">        tags=`wget -q https://registry.hub.docker.com/v1/repositories/<span class="variable">$&#123;1&#125;</span>/tags -O -  | sed -e <span class="string">'s/[][]//g'</span> -e <span class="string">'s/"//g'</span> -e <span class="string">'s/ //g'</span> | tr <span class="string">'&#125;'</span> <span class="string">'\n'</span>  | awk -F: <span class="string">'&#123;print $3&#125;'</span>`</span><br><span class="line">	    <span class="comment">#echo "$&#123;tags&#125;"</span></span><br><span class="line">	    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;tags&#125;</span>"</span> |sort -r &gt;<span class="variable">$HOME</span>/.dockercache/<span class="variable">$1</span></span><br><span class="line">		cat <span class="variable">$HOME</span>/.dockercache/<span class="variable">$1</span> |grep <span class="string">"<span class="variable">$2</span>.*"</span>	</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -lt 1 ]; <span class="keyword">then</span></span><br><span class="line">	usage</span><br><span class="line">	<span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">image=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">[ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"clean"</span> ]&amp;&amp; rm -rf <span class="variable">$HOME</span>/.dockercache&amp;&amp;<span class="built_in">exit</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$2</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">	cache <span class="variable">$image</span> <span class="variable">$2</span></span><br><span class="line">	<span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">cache <span class="variable">$image</span> <span class="string">""</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="Docker-API-使用"><a href="#Docker-API-使用" class="headerlink" title="Docker API 使用"></a>Docker API 使用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># go </span></span><br><span class="line">go get github.com/docker/docker/client</span><br><span class="line"></span><br><span class="line"><span class="comment"># python</span></span><br><span class="line">pip install docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># curl</span></span><br><span class="line"><span class="comment"># 创建容器</span></span><br><span class="line">$ curl --unix-socket /var/run/docker.sock -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  -d <span class="string">'&#123;"Image": "alpine", "Cmd": ["echo", "hello world"]&#125;'</span> \</span><br><span class="line">  -X POST http:/v1.24/containers/create</span><br><span class="line"><span class="comment"># 返回容器id</span></span><br><span class="line">&#123;<span class="string">"Id"</span>:<span class="string">"1c6594faf5"</span>,<span class="string">"Warnings"</span>:null&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动容器</span></span><br><span class="line">$ curl --unix-socket /var/run/docker.sock -X POST http:/v1.24/containers/1c6594faf5/start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">$ curl --unix-socket /var/run/docker.sock -X POST http:/v1.24/containers/1c6594faf5/<span class="built_in">wait</span></span><br><span class="line">&#123;<span class="string">"StatusCode"</span>:0&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">$ curl --unix-socket /var/run/docker.sock <span class="string">"http:/v1.24/containers/1c6594faf5/logs?stdout=1"</span></span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>
<h3 id="Docker-go-API"><a href="#Docker-go-API" class="headerlink" title="Docker go API"></a>Docker go API</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/docker/docker/api/types"</span></span><br><span class="line">	<span class="string">"github.com/docker/docker/api/types/container"</span></span><br><span class="line">	<span class="string">"github.com/docker/docker/client"</span></span><br><span class="line">	<span class="string">"github.com/docker/docker/pkg/stdcopy"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// "github.com/docker/docker/client"</span></span><br><span class="line">    ctx := context.Background()</span><br><span class="line">    cli, err := client.NewClientWithOpts(client.FromEnv, client.WithAPIVersionNegotiation())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拉取镜像</span></span><br><span class="line">    reader, err := cli.ImagePull(ctx, <span class="string">"docker.io/library/alpine"</span>, types.ImagePullOptions&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    io.Copy(os.Stdout, reader)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建容器</span></span><br><span class="line">    resp, err := cli.ContainerCreate(ctx, &amp;container.Config&#123;</span><br><span class="line">        Image: <span class="string">"alpine"</span>,</span><br><span class="line">        Cmd:   []<span class="keyword">string</span>&#123;<span class="string">"echo"</span>, <span class="string">"hello world"</span>&#125;,</span><br><span class="line">    &#125;, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="string">""</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动容器</span></span><br><span class="line">    <span class="keyword">if</span> err := cli.ContainerStart(ctx, resp.ID, types.ContainerStartOptions&#123;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查看状态</span></span><br><span class="line">    statusCh, errCh := cli.ContainerWait(ctx, resp.ID, container.WaitConditionNotRunning)</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> err := &lt;-errCh:</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> &lt;-statusCh:</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查看日志</span></span><br><span class="line">    out, err := cli.ContainerLogs(ctx, resp.ID, types.ContainerLogsOptions&#123;ShowStdout: <span class="literal">true</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    stdcopy.StdCopy(os.Stdout, os.Stderr, out)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanqi.cf/2020/05/Jenkins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yan qi">
      <meta itemprop="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blyanqi@163.com">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/Jenkins/" class="post-title-link" itemprop="url">jinkens</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-14 08:38:02" itemprop="dateCreated datePublished" datetime="2020-05-14T08:38:02+08:00">2020-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-09 23:55:40" itemprop="dateModified" datetime="2020-06-09T23:55:40+08:00">2020-06-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><a href="https://www.jenkins.io/" target="_blank" rel="noopener">jenkins</a></li>
<li><a href="http://mirrors.jenkins-ci.org/status.html" target="_blank" rel="noopener">jenkins 插件镜像</a></li>
<li><a href="https://github.com/jenkins-zh" target="_blank" rel="noopener">jenkins 中文社区</a></li>
<li><a href="https://plugins.jenkins.io/" target="_blank" rel="noopener">jenkins plugins center</a></li>
<li><a href="https://hub.docker.com/_/jenkins" target="_blank" rel="noopener">jenkins dockerfile </a></li>
<li><a href="https://github.com/jenkinsci/docker" target="_blank" rel="noopener">jenkins github </a></li>
</ul>
<h2 id="docker-compose-安装"><a href="#docker-compose-安装" class="headerlink" title="docker-compose 安装"></a>docker-compose 安装</h2><p>JENKINS_UC：主要的插件更新中心，会提供Jenkin 长期支持的版本。默认值就是 <a href="https://updates.jenkins.io" target="_blank" rel="noopener">https://updates.jenkins.io</a>.<br>JENKINS_UC_EXPERIMENTAL：主要的插件开发/实验版本更新中心。<br>JENKINS_UC_DOWNLOAD：从插件更新中心的下载链接，默认为 $JENKINS_UC/downloads。</p>
<blockquote>
<p>使用最新的docker 镜像进行安装，安装完成报 jenkins 不是最新的。尝试了很多次插件安装的问题都不成功。<br>自己下载了jenkins.war 包制作镜像。</p>
</blockquote>
<h2 id="jenkins-conceptual"><a href="#jenkins-conceptual" class="headerlink" title="jenkins conceptual"></a>jenkins conceptual</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">item        <span class="comment"># 工程</span></span><br><span class="line">pipeline    <span class="comment"># 流水线</span></span><br><span class="line">build       <span class="comment"># 构建</span></span><br><span class="line">hook        <span class="comment"># 钩子</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义执行环境</span></span><br><span class="line">workspace   <span class="comment"># 工作空间，包含来自远程仓库的文件和一些用于Pipeline的工作文件</span></span><br><span class="line">agent       <span class="comment">#</span></span><br><span class="line">stages      <span class="comment"># 块</span></span><br><span class="line">    stage(<span class="string">'Build'</span>)   <span class="comment">#</span></span><br><span class="line">    stage(<span class="string">'Test'</span>)    <span class="comment">#</span></span><br><span class="line">    stage(<span class="string">'Deploy'</span>)  <span class="comment">#</span></span><br><span class="line">        steps   <span class="comment"># 步骤</span></span><br><span class="line">executor    <span class="comment"># 执行器</span></span><br><span class="line"> </span><br><span class="line">environment <span class="comment"># 定义环境变量</span></span><br><span class="line">post        </span><br><span class="line">    always      <span class="comment">#</span></span><br><span class="line">    success     <span class="comment">#</span></span><br><span class="line">    unstable    <span class="comment">#</span></span><br><span class="line">    failure     <span class="comment">#</span></span><br><span class="line">    changed     <span class="comment">#</span></span><br><span class="line"><span class="comment"># 通知</span></span><br><span class="line">mail to:        <span class="comment">#</span></span><br><span class="line"><span class="comment"># 部署</span></span><br></pre></td></tr></table></figure>
<h2 id="jenkins-daemon-安装"><a href="#jenkins-daemon-安装" class="headerlink" title="jenkins daemon 安装"></a>jenkins daemon 安装</h2><ul>
<li><a href="http://mirrors.jenkins.io/war-stable/latest/jenkins.war" target="_blank" rel="noopener">jenkins 下载</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行jenkins</span></span><br><span class="line">java -jar jenkins.war --httpPort=8080.</span><br><span class="line"><span class="comment"># 访问</span></span><br><span class="line">http://localhost:8080</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="docker-镜像安装-Jenkins（不推荐，安装了好多次始终无法解决插件问题）"><a href="#docker-镜像安装-Jenkins（不推荐，安装了好多次始终无法解决插件问题）" class="headerlink" title="docker 镜像安装 Jenkins（不推荐，安装了好多次始终无法解决插件问题）"></a>docker 镜像安装 Jenkins（不推荐，安装了好多次始终无法解决插件问题）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找镜像</span></span><br><span class="line">docker search jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">docker pull jenkins/jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建容器</span></span><br><span class="line">docker container create --name=jenkins -p 8080:8080 jenkins/jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器</span></span><br><span class="line">docker container ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动容器</span></span><br><span class="line">docker container start e32ee41a614b</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改容器资源</span></span><br><span class="line">docker container update --cpus 2  e32ee41a614b</span><br></pre></td></tr></table></figure>
<h2 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一直停在 Your browser will reload automatically when Jenkins is ready.</span></span><br><span class="line">需要你进入jenkins的工作目录，打开-----hudson.model.UpdateCenter.xml将 url 中的 </span><br><span class="line">https://updates.jenkins.io/update-center.json</span><br><span class="line">更改为</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span><br></pre></td></tr></table></figure>
<h2 id="下载最新版本-自己-build-一个镜像"><a href="#下载最新版本-自己-build-一个镜像" class="headerlink" title="下载最新版本 自己 build 一个镜像"></a>下载最新版本 自己 build 一个镜像</h2><p>build 过程中直接使用 root 用户<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">mkdir jenkins</span><br><span class="line"><span class="built_in">cd</span> jenkins</span><br><span class="line"><span class="comment"># 把官方的 dockerfile 下载下来</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/jenkinsci/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载 war</span></span><br><span class="line">wget http://ftp-nyc.osuosl.org/pub/jenkins/war-stable/2.222.4/jenkins.war -o ./docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目录结构</span></span><br><span class="line">/Users/alert/jenkins</span><br><span class="line">├── data</span><br><span class="line">│   └── jenkins <span class="comment">#启动时数据目录</span></span><br><span class="line">├── docker <span class="comment"># build 目录</span></span><br><span class="line">│   ├── CHANGELOG.md</span><br><span class="line">│   ├── CONTRIBUTING.md</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   ├── Dockerfile-alpine</span><br><span class="line">│   ├── Dockerfile-centos</span><br><span class="line">│   ├── Dockerfile-jdk11</span><br><span class="line">│   ├── Dockerfile-openj9</span><br><span class="line">│   ├── Dockerfile-openj9-jdk11</span><br><span class="line">│   ├── Dockerfile-slim</span><br><span class="line">│   ├── Dockerfile.bak</span><br><span class="line">│   ├── HACKING.adoc</span><br><span class="line">│   ├── Jenkinsfile</span><br><span class="line">│   ├── LICENSE.txt</span><br><span class="line">│   ├── Makefile</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   ├── docker-compose.yml</span><br><span class="line">│   ├── install-plugins.sh</span><br><span class="line">│   ├── jenkins-support</span><br><span class="line">│   ├── jenkins.sh</span><br><span class="line">│   ├── jenkins.war</span><br><span class="line">│   ├── multiarch</span><br><span class="line">│   ├── plugins.sh</span><br><span class="line">│   ├── publish-experimental.sh</span><br><span class="line">│   ├── publish.sh</span><br><span class="line">│   ├── tests</span><br><span class="line">│   ├── tini-shim.sh</span><br><span class="line">│   ├── tini_pub.gpg</span><br><span class="line">│   └── tools</span><br><span class="line">├── docker-compose.yml <span class="comment"># docker-compose 文件</span></span><br><span class="line">└── dockertags <span class="comment"># 获取标签的脚本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 yum 源</span></span><br><span class="line">yum repolist</span><br><span class="line">--enablerepo=xx</span><br><span class="line"></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-8.repo</span><br><span class="line"></span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br></pre></td></tr></table></figure></p>
<h2 id="修改dockerfile"><a href="#修改dockerfile" class="headerlink" title="修改dockerfile"></a>修改dockerfile</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 dockerfile</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;<span class="string">'GEOF'</span> &gt;docker/Dockerfile</span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-stretch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用阿里云镜像</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb http://mirrors.aliyun.com/debian/ stretch main non-free contrib"</span> &gt;/etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">&amp;&amp;<span class="built_in">echo</span> <span class="string">"deb-src http://mirrors.aliyun.com/debian/ stretch main non-free contrib"</span> &gt;&gt;/etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">&amp;&amp;<span class="built_in">echo</span> <span class="string">"deb http://mirrors.aliyun.com/debian-security stretch/updates main"</span> &gt;&gt;/etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">&amp;&amp;<span class="built_in">echo</span> <span class="string">"deb-src http://mirrors.aliyun.com/debian-security stretch/updates main"</span> &gt;&gt;/etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">&amp;&amp;<span class="built_in">echo</span> <span class="string">"deb http://mirrors.aliyun.com/debian/ stretch-updates main non-free contrib"</span> &gt;&gt;/etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">&amp;&amp;<span class="built_in">echo</span> <span class="string">"deb-src http://mirrors.aliyun.com/debian/ stretch-updates main non-free contrib"</span> &gt;&gt;/etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">&amp;&amp;<span class="built_in">echo</span> <span class="string">"deb http://mirrors.aliyun.com/debian/ stretch-backports main non-free contrib"</span> &gt;&gt;/etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">&amp;&amp;<span class="built_in">echo</span> <span class="string">"deb-src http://mirrors.aliyun.com/debian/ stretch-backports main non-free contrib"</span> &gt;&gt;/etc/apt/sources.list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 去掉系统更新，系统更新下载太慢了</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get upgrade -y&amp;&amp;apt-get install -y git curl &amp;&amp; curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash &amp;&amp; apt-get install -y git-lfs &amp;&amp; git lfs install &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 root 用户</span></span><br><span class="line"><span class="keyword">ARG</span> <span class="keyword">user</span>=root</span><br><span class="line"><span class="keyword">ARG</span> group=root</span><br><span class="line"><span class="keyword">ARG</span> uid=<span class="number">0</span></span><br><span class="line"><span class="keyword">ARG</span> gid=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> http_port=<span class="number">8080</span></span><br><span class="line"><span class="keyword">ARG</span> agent_port=<span class="number">50000</span></span><br><span class="line"><span class="keyword">ARG</span> JENKINS_HOME=/var/jenkins_home</span><br><span class="line"><span class="keyword">ARG</span> REF=/usr/share/jenkins/ref</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JENKINS_HOME $JENKINS_HOME</span><br><span class="line"><span class="keyword">ENV</span> JENKINS_SLAVE_AGENT_PORT $&#123;agent_port&#125;</span><br><span class="line"><span class="keyword">ENV</span> REF $REF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改了一下，不要创建新用户</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p <span class="variable">$JENKINS_HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> <span class="variable">$JENKINS_HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p <span class="variable">$&#123;REF&#125;</span>/init.groovy.d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> TINI_VERSION=v0.<span class="number">16.1</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> tini_pub.gpg <span class="variable">$&#123;JENKINS_HOME&#125;</span>/tini_pub.gpg</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -fsSL https://github.com/krallin/tini/releases/download/<span class="variable">$&#123;TINI_VERSION&#125;</span>/tini-static-$(dpkg --<span class="built_in">print</span>-architecture) -o /sbin/tini \</span></span><br><span class="line"><span class="bash">  &amp;&amp; curl -fsSL https://github.com/krallin/tini/releases/download/<span class="variable">$&#123;TINI_VERSION&#125;</span>/tini-static-$(dpkg --<span class="built_in">print</span>-architecture).asc -o /sbin/tini.asc \</span></span><br><span class="line"><span class="bash">  &amp;&amp; gpg --no-tty --import <span class="variable">$&#123;JENKINS_HOME&#125;</span>/tini_pub.gpg \</span></span><br><span class="line"><span class="bash">  &amp;&amp; gpg --verify /sbin/tini.asc \</span></span><br><span class="line"><span class="bash">  &amp;&amp; rm -rf /sbin/tini.asc /root/.gnupg \</span></span><br><span class="line"><span class="bash">  &amp;&amp; chmod +x /sbin/tini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> JENKINS_VERSION</span><br><span class="line"><span class="keyword">ENV</span> JENKINS_VERSION $&#123;JENKINS_VERSION:-<span class="number">2.176</span>.<span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> JENKINS_SHA=<span class="number">33</span>a6c3161cf8de9c8729fd83914d781319fd1569acf487c7b1121681dba190a5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把下载的 jenkins.war 添加到镜像</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./jenkins.war /usr/share/jenkins/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以把此处改了</span></span><br><span class="line"><span class="keyword">ENV</span> JENKINS_UC https://updates.jenkins.io</span><br><span class="line"><span class="keyword">ENV</span> JENKINS_UC_EXPERIMENTAL=https://updates.jenkins.io/experimental</span><br><span class="line"><span class="keyword">ENV</span> JENKINS_INCREMENTALS_REPO_MIRROR=https://repo.jenkins-ci.org/incrementals</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R <span class="variable">$&#123;user&#125;</span> <span class="string">"<span class="variable">$JENKINS_HOME</span>"</span> <span class="string">"<span class="variable">$REF</span>"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> $&#123;http_port&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> $&#123;agent_port&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> COPY_REFERENCE_FILE_LOG $JENKINS_HOME/copy_reference_file.log</span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> $&#123;<span class="keyword">user</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> jenkins-support /usr/<span class="built_in">local</span>/bin/jenkins-support</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> jenkins.sh /usr/<span class="built_in">local</span>/bin/jenkins.sh</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> tini-shim.sh /bin/tini</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/sbin/tini"</span>, <span class="string">"--"</span>, <span class="string">"/usr/local/bin/jenkins.sh"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> plugins.sh /usr/<span class="built_in">local</span>/bin/plugins.sh</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> install-plugins.sh /usr/<span class="built_in">local</span>/bin/install-plugins.sh</span></span><br><span class="line">GEOF</span><br></pre></td></tr></table></figure>
<h2 id="开始-build"><a href="#开始-build" class="headerlink" title="开始 build"></a>开始 build</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开始 build</span></span><br><span class="line">docker build -t myjenkins:0.1 .</span><br><span class="line"><span class="comment"># docker build -f ./Dockerfile-centos -t myjenkins:0.1 .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line">cat &lt;&lt;EOF &gt;docker-compose.yml</span><br><span class="line">version: <span class="string">"3.8"</span></span><br><span class="line">services:</span><br><span class="line">  jenkins:</span><br><span class="line">    container_name: jenkins</span><br><span class="line">    image: myjenkins:0.1</span><br><span class="line">    volumes:</span><br><span class="line">    - ./data/jenkins:/var/jenkins_home:z</span><br><span class="line">    ports:</span><br><span class="line">    - 8080:8080</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">    - JENKINS_UC=https://mirrors.tuna.tsinghua.edu.cn</span><br><span class="line">    - JENKINS_UC_EXPERIMENTAL=https://mirrors.tuna.tsinghua.edu.cn/experimental</span><br><span class="line">    <span class="comment">#- JAVA_OPTS=-Dhudson.footerURL=https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json jenkins</span></span><br><span class="line">networks:</span><br><span class="line">  jenkins-net:</span><br><span class="line">    driver: bridge</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="comment"># docker-compose.yml build</span></span><br><span class="line">cat &lt;&lt;EOF &gt;docker-compose.yml</span><br><span class="line">version: <span class="string">"3.8"</span></span><br><span class="line">services:</span><br><span class="line">  jenkins:</span><br><span class="line">    container_name: jenkins</span><br><span class="line">    build:</span><br><span class="line">      context: ./docker</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    image: myjenkins:latest</span><br><span class="line">    volumes:</span><br><span class="line">    - ./data/jenkins:/var/jenkins_home:z</span><br><span class="line">    ports:</span><br><span class="line">    - 8080:8080</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">    - JENKINS_UC=https://mirrors.tuna.tsinghua.edu.cn</span><br><span class="line">    - JENKINS_UC_EXPERIMENTAL=https://mirrors.tuna.tsinghua.edu.cn/experimental</span><br><span class="line">    <span class="comment">#- JAVA_OPTS=-Dhudson.footerURL=https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json jenkins</span></span><br><span class="line">networks:</span><br><span class="line">  jenkins-net:</span><br><span class="line">    driver: bridge</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接build</span></span><br><span class="line">docker-compose up --build -d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line"><span class="comment"># 使用 docker-compose 运行</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 密码路径 /var/jenkins_home/secrets/initialAdminPassword</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择安装插件，选择不安装插件</span></span><br><span class="line"><span class="comment"># 关于插件用 docker 官方的镜像改了很多次都不行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置用户名密码</span></span><br><span class="line">admin,admin<span class="comment">#123.com</span></span><br></pre></td></tr></table></figure>
<h2 id="手动插件安装"><a href="#手动插件安装" class="headerlink" title="手动插件安装"></a>手动插件安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 手动安装插件 https://mirrors.tuna.tsinghua.edu.cn/jenkins/plugins/</span></span><br><span class="line">Jenkins -&gt; Plugin Manager -&gt; Upload Plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 语言插件 locale</span></span><br><span class="line"><span class="comment"># Manager jenkins -&gt; configure system  -&gt; locale -&gt; 填入 zh_CN -&gt; 勾选所有用户生效</span></span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/plugins/locale/latest/locale.hpi</span><br></pre></td></tr></table></figure>
<h2 id="配置jenkins"><a href="#配置jenkins" class="headerlink" title="配置jenkins"></a>配置jenkins</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 密码路径 /var/jenkins_home/secrets/initialAdminPassword</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置插件更新地址 Jenkins -&gt; Plugin Manager -&gt; Update Site</span></span><br><span class="line">https://updates.jenkins.io/update-center.json</span><br><span class="line">改</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># Jenkins -&gt; Plugin Manager -&gt; installed -&gt; 需要重启会提示</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line"><span class="comment"># 设置时区</span></span><br><span class="line"><span class="comment"># 安装Role Strategy Plugin插件</span></span><br><span class="line"><span class="comment"># 实现不同用户组显示对应视图views中不同的jobs</span></span><br><span class="line"><span class="comment"># 配置 email</span></span><br><span class="line"><span class="comment"># 注册凭证</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanqi.cf/2020/05/%E7%BC%96%E7%A8%8B%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yan qi">
      <meta itemprop="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blyanqi@163.com">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/%E7%BC%96%E7%A8%8B%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">编程方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-05-14 08:34:21 / 修改时间：08:41:18" itemprop="dateCreated datePublished" datetime="2020-05-14T08:34:21+08:00">2020-05-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>99</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>表达式<ul>
<li>常量</li>
<li>变量</li>
<li>运算符</li>
</ul>
</li>
<li>控制流程<ul>
<li>分支</li>
<li>循环</li>
</ul>
</li>
<li>容器<ul>
<li>数组</li>
<li>切片</li>
<li>Map</li>
</ul>
</li>
<li>函数<ul>
<li>参数</li>
<li>返回值</li>
<li>闭包</li>
<li>递归函数</li>
</ul>
</li>
<li>面向对象<ul>
<li>接口</li>
<li>结构体</li>
<li>指针</li>
</ul>
</li>
<li>设计模式<ul>
<li>单例模式</li>
<li>工厂模式</li>
</ul>
</li>
<li>Golang 并发<ul>
<li>Channel</li>
<li>sync</li>
</ul>
</li>
<li>错误处理</li>
<li>日志记录</li>
<li>常用包</li>
<li>包管理</li>
<li>基本库</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanqi.cf/2020/05/shell%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yan qi">
      <meta itemprop="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blyanqi@163.com">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/shell%E7%BC%96%E7%A8%8B/" class="post-title-link" itemprop="url">shell编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-14 08:33:21" itemprop="dateCreated datePublished" datetime="2020-05-14T08:33:21+08:00">2020-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-26 19:09:44" itemprop="dateModified" datetime="2020-05-26T19:09:44+08:00">2020-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><a href="https://www.gnu.org/savannah-checkouts/gnu/bash/manual/bash.html" target="_blank" rel="noopener">bash docs</a></li>
<li><a href="http://tldp.org/LDP/abs/html/index.html" target="_blank" rel="noopener">Advanced Bash-Scripting Guide</a></li>
</ul>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><h3 id="shell-输入、输出"><a href="#shell-输入、输出" class="headerlink" title="shell 输入、输出"></a>shell 输入、输出</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">read</span> var <span class="comment">#输入</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$var</span> <span class="comment">#输出</span></span><br></pre></td></tr></table></figure>
<h3 id="shell-变量"><a href="#shell-变量" class="headerlink" title="shell 变量"></a>shell 变量</h3><blockquote>
<p>shell中变量值都是字符串类型<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 声明</span></span><br><span class="line">var=2</span><br><span class="line">var=<span class="string">"hello world"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$var</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 高级用法</span></span><br><span class="line">var=<span class="string">"ls"</span></span><br><span class="line"><span class="built_in">eval</span> <span class="variable">$var</span> <span class="comment"># 将字符串变成命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用变量进行字符串截取</span></span><br><span class="line">var=<span class="string">"hello world"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;var%*o&#125;</span>  <span class="comment"># 保留o左边字符</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;var%%o*&#125;</span> <span class="comment"># 贪婪匹配</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;var#o*&#125;</span>  <span class="comment"># 保留o右边字符</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;var##*o&#125;</span> <span class="comment">#贪婪匹配</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 变量判断</span></span><br><span class="line"><span class="variable">$&#123;parameter:=word&#125;</span> <span class="comment"># （无值替换）</span></span><br><span class="line"><span class="variable">$&#123;parameter:+word&#125;</span> <span class="comment"># （有值才替换）</span></span><br><span class="line"><span class="variable">$&#123;parameter:-word&#125;</span> <span class="comment"># （为空替换）</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;parameter:?word&#125;</span> <span class="comment"># </span></span><br><span class="line"><span class="variable">$&#123;parameter:offset&#125;</span> <span class="comment"># 获取偏移字符</span></span><br><span class="line"><span class="variable">$&#123;parameter:offset:length&#125;</span></span><br></pre></td></tr></table></figure><br><a href="https://www.gnu.org/software/bash/manual/bash.html#Shell-Parameter-Expansion" target="_blank" rel="noopener">Shell-Parameter-Expansion</a></p>
</blockquote>
<h3 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># ((...))</span><br><span class="line">(( expression ))</span><br><span class="line"></span><br><span class="line"># let</span><br><span class="line">let <span class="string">"expression"</span></span><br><span class="line"></span><br><span class="line"># <span class="string">[[…]]</span></span><br><span class="line"><span class="string">[[ expression ]]</span></span><br><span class="line"></span><br><span class="line"># 模式匹配 ‘aab’ <span class="keyword">and</span> ‘ aaaaaab’ 会被匹配</span><br><span class="line"><span class="string">[[ $line =~ [[:space:]]*?(a)b ]]</span></span><br><span class="line"></span><br><span class="line"># 提高优先级使用小括号</span><br><span class="line">( expression )</span><br><span class="line"></span><br><span class="line"># 取反</span><br><span class="line">! expression</span><br><span class="line"></span><br><span class="line"># 取与</span><br><span class="line">expression1 &amp;&amp; expression2</span><br><span class="line"></span><br><span class="line"># 取或</span><br><span class="line">expression1 || expression2</span><br></pre></td></tr></table></figure>
<h3 id="shell-控制流程"><a href="#shell-控制流程" class="headerlink" title="shell 控制流程"></a>shell 控制流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if # 判断</span></span><br><span class="line">i=10</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$i</span> -gt 20 ];<span class="keyword">then</span> <span class="comment"># 数值比较</span></span><br><span class="line">        <span class="built_in">echo</span> gt 20</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> lt 20</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"mm"</span> == <span class="string">"m1"</span> ];<span class="keyword">then</span>  <span class="comment"># 字符串比较</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"some strings"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"different strings"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ls /datamm 2&gt;/dev/null ;<span class="keyword">then</span> <span class="comment"># 命令处理</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"list file ok"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"file is not exist"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">------------------------------</span><br><span class="line"><span class="comment"># case in</span></span><br><span class="line"><span class="comment"># 常用 case in 制作菜单</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">read</span> var <span class="comment"># 读入字符串</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$var</span> <span class="keyword">in</span> <span class="comment"># 判断</span></span><br><span class="line">        dog|cat)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"animal"</span></span><br><span class="line">        ;;</span><br><span class="line">        1|2)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"number"</span></span><br><span class="line">        ;;</span><br><span class="line">        q)</span><br><span class="line">        <span class="built_in">exit</span> 0 <span class="comment"># 退出</span></span><br><span class="line">        ;;</span><br><span class="line">        *)  <span class="comment"># 不匹配输出</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"entry dog|cat|1|2"</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">------------------------------</span><br><span class="line"><span class="comment"># for</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">"abc bcd"</span> <span class="comment"># 空格分隔</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$x</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (( i=0;i&lt;10;i++ )) <span class="comment"># 计数 </span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ((;;)) <span class="comment"># 死循环</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> for..ok</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># while</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="comment"># 死循环</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> while..ok</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">A=<span class="variable">$IFS</span></span><br><span class="line">IFS=$<span class="string">":"</span> <span class="comment"># 改变分隔符</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line1 line2 <span class="comment"># 把一行读成两个字段</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$line1</span></span><br><span class="line"><span class="keyword">done</span> &lt;&gt;/etc/passwd</span><br><span class="line">IFS=<span class="variable">$A</span></span><br><span class="line"></span><br><span class="line">A=<span class="variable">$IFS</span></span><br><span class="line">IFS=$<span class="string">":"</span></span><br><span class="line">cat /etc/passwd| <span class="keyword">while</span> <span class="built_in">read</span> line1 <span class="comment"># 通过输出重定向读入</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$line1</span></span><br><span class="line"><span class="comment">#echo $line1 $line2</span></span><br><span class="line"><span class="keyword">done</span> </span><br><span class="line">IFS=<span class="variable">$A</span></span><br><span class="line"></span><br><span class="line">i=2</span><br><span class="line"><span class="keyword">while</span> ((i&lt;10)) <span class="comment"># 比较数值大小</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$i</span></span><br><span class="line">i=$(expr <span class="variable">$i</span> + 1) <span class="comment"># 自增</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># while 跟 for 的区别</span></span><br><span class="line">seq 60 62|<span class="keyword">while</span> <span class="built_in">read</span> n</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">ssh 192.168.0.<span class="variable">$n</span> <span class="string">"echo ok"</span> <span class="comment"># 只会执行一次</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">---</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> `seq 60 62`;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">ssh 192.168.0.<span class="variable">$n</span> <span class="string">"echo ok"</span> <span class="comment"># 会依次执行</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.yanqi.cf/2020/05/python%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yan qi">
      <meta itemprop="description" content="君子学以聚之，问以辩之，宽以居之，仁以行之。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blyanqi@163.com">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/python%E7%BC%96%E7%A8%8B/" class="post-title-link" itemprop="url">python编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-14 08:32:40" itemprop="dateCreated datePublished" datetime="2020-05-14T08:32:40+08:00">2020-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-18 16:09:59" itemprop="dateModified" datetime="2020-05-18T16:09:59+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://www.runoob.com/python3/python3-tutorial.html" target="_blank" rel="noopener">Python 入门</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">yan qi</p>
  <div class="site-description" itemprop="description">君子学以聚之，问以辩之，宽以居之，仁以行之。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">135</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">by yanqi.</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">312k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4:44</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
